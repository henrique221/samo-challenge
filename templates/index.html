<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Intelligence - AI-Powered Video Analysis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #ff6b35;
            --primary-dark: #e85a2a;
            --primary-light: #ff8c42;
            --secondary: #ff9558;
            --accent: #ffa366;
            --background: #0a0a0a;
            --surface: #141414;
            --surface-light: #1f1f1f;
            --surface-hover: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b8b8b8;
            --text-muted: #888888;
            --border: #2a2a2a;
            --border-light: #333333;
            --gradient-orange: linear-gradient(135deg, #ff6b35 0%, #ff9558 100%);
            --gradient-dark: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            --gradient-surface: linear-gradient(145deg, #1f1f1f 0%, #141414 100%);
            --glow-orange: 0 0 30px rgba(255, 107, 53, 0.3);
            --glow-subtle: 0 0 20px rgba(255, 107, 53, 0.15);
            --shadow-card: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 107, 53, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 149, 88, 0.04) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 107, 53, 0.03) 0%, transparent 50%);
            min-height: 100vh;
            color: var(--text-primary);
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(255, 107, 53, 0.01) 2px,
                    rgba(255, 107, 53, 0.01) 4px
                );
            pointer-events: none;
            z-index: 1;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .header {
            text-align: center;
            color: var(--text-primary);
            padding: 60px 20px 40px;
            position: relative;
            z-index: 10;
        }
        
        .header h1 {
            font-size: 3.5em;
            font-weight: 800;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            background: var(--gradient-orange);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.03em;
            position: relative;
        }
        
        .header h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: var(--gradient-orange);
            border-radius: 2px;
            box-shadow: var(--glow-orange);
        }
        
        
        .header p {
            font-size: 1.2em;
            color: var(--text-secondary);
            font-weight: 300;
            margin-top: 20px;
        }
        
        /* URL Input Section */
        .input-section {
            background: transparent;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.5s ease;
        }
        
        .input-section.centered {
            margin-top: 15vh;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            transform: scale(1.05);
        }
        
        /* Fade in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
            transform: translateX(100%);
            transition: transform 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .loading-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 107, 53, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 149, 88, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .loading-overlay.active {
            display: flex;
            transform: translateX(0);
        }
        
        .app-container {
            transition: transform 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .app-container.slide-out {
            transform: translateX(-100%);
        }
        
        .loading-content {
            text-align: center;
            max-width: 450px;
            position: relative;
            z-index: 1;
        }
        
        
        .loading-status {
            font-size: 1.4em;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 15px;
            background: var(--gradient-orange);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .loading-message {
            font-size: 1em;
            color: var(--text-secondary);
            margin-bottom: 30px;
            min-height: 28px;
            font-weight: 300;
            animation: fadeInOut 2s ease-in-out infinite;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .loading-progress {
            width: 100%;
            height: 100px;
            margin-top: 30px;
            position: relative;
            overflow: hidden;
            background: linear-gradient(180deg, 
                transparent 0%, 
                rgba(255, 107, 53, 0.03) 50%, 
                rgba(255, 107, 53, 0.05) 100%
            );
            border-radius: 50px;
        }
        
        .loading-progress-bar {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Multiple wave layers for depth */
        .loading-progress-bar::before,
        .loading-progress-bar::after,
        .loading-progress-bar span::before,
        .loading-progress-bar span::after {
            content: '';
            position: absolute;
            width: 400%;
            height: 100%;
            left: -200%;
            background: linear-gradient(90deg, 
                transparent,
                rgba(255, 107, 53, 0.4),
                rgba(255, 149, 88, 0.6),
                rgba(255, 107, 53, 0.4),
                transparent
            );
            animation: smoothWave 8s cubic-bezier(0.36, 0.45, 0.63, 0.53) infinite;
            transform-origin: center;
        }
        
        /* First wave - bottom layer */
        .loading-progress-bar::before {
            clip-path: url(#wave1);
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 107, 53, 0.3),
                rgba(255, 149, 88, 0.5),
                rgba(255, 107, 53, 0.3),
                transparent
            );
            animation-duration: 12s;
        }
        
        /* Second wave - middle layer */
        .loading-progress-bar::after {
            clip-path: url(#wave2);
            animation-delay: -3s;
            animation-duration: 10s;
            opacity: 0.8;
        }
        
        /* Create span element for additional waves */
        .loading-progress-bar span {
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
        }
        
        /* Third wave - top layer */
        .loading-progress-bar span::before {
            clip-path: url(#wave3);
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 149, 88, 0.3),
                rgba(255, 107, 53, 0.4),
                rgba(255, 149, 88, 0.3),
                transparent
            );
            animation-delay: -6s;
            animation-duration: 14s;
            opacity: 0.6;
        }
        
        /* Shimmer effect on top */
        .loading-progress-bar span::after {
            background: linear-gradient(90deg,
                transparent 30%,
                rgba(255, 255, 255, 0.2) 50%,
                transparent 70%
            );
            animation: shimmerWave 3s ease-in-out infinite;
            clip-path: none;
        }
        
        @keyframes smoothWave {
            0% {
                transform: translateX(0) translateY(0);
            }
            25% {
                transform: translateX(25%) translateY(-3px);
            }
            50% {
                transform: translateX(50%) translateY(0);
            }
            75% {
                transform: translateX(75%) translateY(3px);
            }
            100% {
                transform: translateX(100%) translateY(0);
            }
        }
        
        @keyframes shimmerWave {
            0%, 100% {
                transform: translateX(-100%);
                opacity: 0;
            }
            50% {
                transform: translateX(0%);
                opacity: 1;
            }
        }
        
        .loading-steps {
            display: flex;
            justify-content: space-around;
            margin-top: 50px;
            padding: 30px;
            background: var(--surface);
            border-radius: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .loading-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: var(--border);
            transform: translateY(-50%);
            z-index: 0;
        }
        
        .loading-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.3;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }
        
        .loading-step.active {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .loading-step.completed {
            opacity: 0.7;
        }
        
        .loading-step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface-light);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: all 0.3s;
            color: var(--text-muted);
        }
        
        .loading-step.active .loading-step-icon {
            background: var(--gradient-orange);
            color: white;
            transform: scale(1.2);
            box-shadow: var(--glow-orange);
            border-color: var(--primary);
            animation: pulseIcon 1.5s ease-in-out infinite;
        }
        
        @keyframes pulseIcon {
            0%, 100% { 
                transform: scale(1.2);
                box-shadow: var(--glow-orange);
            }
            50% { 
                transform: scale(1.3);
                box-shadow: 0 0 30px rgba(255, 107, 53, 0.5);
            }
        }
        
        .loading-step.completed .loading-step-icon {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: var(--glow-subtle);
        }
        
        .loading-step-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        @keyframes textPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Modern Video Input Styling */
        .video-input-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .video-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: var(--surface);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background-clip: padding-box;
        }
        
        .video-input-wrapper::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 16px;
            padding: 2px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 0;
        }
        
        .video-input-wrapper:hover::before,
        .video-input-wrapper:focus-within::before {
            opacity: 1;
        }
        
        .input-icon {
            position: absolute;
            left: 20px;
            color: var(--text-muted);
            font-size: 1.2em;
            transition: color 0.3s;
            z-index: 1;
            pointer-events: none;
        }
        
        .video-input-wrapper:focus-within .input-icon {
            color: var(--primary);
        }
        
        .video-input {
            flex: 1;
            padding: 16px 20px 16px 50px;
            background: transparent;
            border: none;
            font-size: 16px;
            color: var(--text-primary);
            transition: all 0.3s;
            position: relative;
            z-index: 2;
        }
        
        .video-input::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }
        
        .video-input:focus {
            outline: none;
        }
        
        .btn-analyze-modern {
            padding: 12px 24px;
            background: var(--gradient-orange);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            margin-right: 4px;
            z-index: 2;
        }
        
        .btn-analyze-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-analyze-modern:hover::before {
            left: 100%;
        }
        
        .btn-analyze-modern:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
        }
        
        .btn-analyze-modern:active {
            transform: scale(0.98);
        }
        
        .btn-analyze-modern:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Legacy input group for backwards compatibility */
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input {
            flex: 1;
            padding: 16px 24px;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .input-group input::placeholder {
            color: var(--text-muted);
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--surface-hover);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2), var(--glow-subtle);
        }
        
        .btn-analyze {
            padding: 16px 36px;
            background: var(--gradient-orange);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .btn-analyze::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-analyze:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-analyze:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--glow-orange), 0 10px 30px rgba(255, 107, 53, 0.3);
        }
        
        .btn-analyze:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        @media (max-width: 640px) {
            .video-input-wrapper {
                flex-direction: column;
                padding: 8px;
            }
            
            .video-input {
                width: 100%;
                padding: 14px 20px 14px 45px;
                font-size: 14px;
            }
            
            .btn-analyze-modern {
                width: 100%;
                justify-content: center;
                margin-right: 0;
                margin-top: 8px;
            }
        }
        
        /* Main Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 640px) {
            .content-grid {
                gap: 15px;
            }
            
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
        
        /* Video Section */
        .video-section {
            background: var(--surface);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border);
            position: relative;
        }
        
        .video-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--primary) 50%, transparent 100%);
            opacity: 0.5;
        }
        
        .video-container {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border-bottom: 1px solid var(--border);
        }
        
        .video-container video {
            width: 100%;
            height: 100%;
            display: none;
            background: #000;
            object-fit: contain;
        }
        
        /* Custom Video Controls */
        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, transparent 100%);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 20;
        }
        
        .video-container:hover .video-controls {
            opacity: 1;
        }
        
        .video-controls.visible {
            opacity: 1;
        }
        
        .play-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: all 0.2s;
        }
        
        .play-btn:hover {
            transform: scale(1.1);
            color: var(--primary);
        }
        
        .time-display {
            color: white;
            font-size: 13px;
            font-weight: 500;
            font-family: 'Monaco', 'Courier New', monospace;
            white-space: nowrap;
            min-width: 100px;
        }
        
        .progress-bar {
            flex: 1;
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            overflow: visible;
        }
        
        .progress-bar:hover {
            height: 7px;
        }
        
        .progress-filled {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            position: relative;
            transition: width 0.1s linear;
        }
        
        .progress-bar:hover .progress-filled::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .volume-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            transition: all 0.2s;
        }
        
        .volume-btn:hover {
            color: var(--primary);
        }
        
        .volume-slider {
            width: 80px;
            height: 4px;
            opacity: 0;
            transition: all 0.3s;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .volume-slider:hover::-webkit-slider-thumb {
            transform: scale(1.2);
        }
        
        .volume-slider:hover::-moz-range-thumb {
            transform: scale(1.2);
        }
        
        .volume-control:hover .volume-slider {
            opacity: 1;
        }
        
        .control-btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            color: var(--primary);
            transform: scale(1.1);
        }
        
        .speed-selector {
            position: relative;
        }
        
        .speed-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .speed-btn:hover {
            background: rgba(255, 107, 53, 0.2);
            border-color: var(--primary);
        }
        
        .speed-options {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 5px 0;
            margin-bottom: 5px;
            display: none;
        }
        
        .speed-options.show {
            display: block;
        }
        
        .speed-option {
            padding: 8px 15px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .speed-option:hover {
            background: rgba(255, 107, 53, 0.3);
        }
        
        .speed-option.active {
            color: var(--primary);
            font-weight: 600;
        }
        
        /* Video Loading Spinner */
        .video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        .video-loading.show {
            display: block;
        }
        
        .video-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Big Play Button Overlay */
        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 15;
        }
        
        .play-overlay:hover {
            background: rgba(255, 107, 53, 0.8);
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .play-overlay i {
            color: white;
            font-size: 30px;
            margin-left: 5px;
        }
        
        .video-container.playing .play-overlay {
            display: none;
        }
        
        /* Video Timeline with Markers */
        .video-timeline {
            position: absolute;
            bottom: 65px;
            left: 10px;
            right: 10px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            z-index: 10;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .video-timeline-progress {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            position: relative;
            transition: width 0.1s linear;
        }
        
        .timeline-marker {
            position: absolute;
            top: -12px;
            width: 4px;
            height: 32px;
            background: var(--secondary);
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 5;
        }
        
        .timeline-marker:hover {
            background: var(--primary);
            transform: scaleY(1.2);
            z-index: 10;
        }
        
        .timeline-marker-tooltip {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 250px;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        
        .timeline-marker:hover .timeline-marker-tooltip {
            opacity: 1;
        }
        
        /* Chapter Navigation */
        .video-chapters {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 10px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 20;
        }
        
        .video-chapters.show {
            display: block;
        }
        
        .video-chapters h4 {
            color: white;
            margin: 0 0 10px 0;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .chapter-item {
            color: rgba(255, 255, 255, 0.8);
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chapter-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .chapter-item.active {
            background: var(--primary);
            color: white;
        }
        
        .chapter-time {
            font-weight: 600;
            color: var(--secondary);
            min-width: 45px;
        }
        
        .chapter-item.active .chapter-time {
            color: white;
        }
        
        /* Toggle Chapters Button */
        .toggle-chapters {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            z-index: 15;
            transition: all 0.2s;
        }
        
        .toggle-chapters:hover {
            background: rgba(0, 0, 0, 0.7);
        }
        
        .video-placeholder {
            color: #666;
            text-align: center;
        }
        
        .video-placeholder i {
            font-size: 3em;
            color: #999;
            margin-bottom: 10px;
        }
        
        .video-info {
            padding: 25px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: none;
        }
        
        .video-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .video-meta {
            display: flex;
            gap: 20px;
            color: var(--text-secondary);
            font-size: 0.95em;
        }
        
        .video-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .video-meta i {
            color: var(--primary);
        }
        
        /* AI Analysis Section */
        .analysis-section {
            background: var(--surface);
            border-radius: 20px;
            padding: 0;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border);
            height: fit-content;
            overflow: hidden;
            position: relative;
        }
        
        .analysis-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--primary) 50%, transparent 100%);
            opacity: 0.5;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 20px 25px;
            background: var(--gradient-orange);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .section-header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        .section-header h2 {
            font-size: 1.3em;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-header i {
            color: white;
            font-size: 1.2em;
        }
        
        .analysis-body {
            padding: 25px;
            background: var(--surface);
        }
        
        /* Mode Selector Pills */
        .mode-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .mode-pill {
            padding: 10px 18px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--surface-light);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .mode-pill .material-icons-outlined {
            font-size: 18px;
            line-height: 1;
        }
        
        .mode-pill:hover {
            border-color: var(--primary);
            background: var(--surface-hover);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--glow-subtle);
        }
        
        .mode-pill.active {
            background: var(--gradient-orange);
            color: white;
            border-color: var(--primary);
            box-shadow: var(--glow-subtle);
        }
        
        /* Custom Prompt */
        .custom-prompt-card {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px dashed rgba(255, 107, 53, 0.5);
            animation: slideDown 0.3s ease;
            position: relative;
        }
        
        .custom-prompt-card::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: 16px;
            padding: 1px;
            background: var(--gradient-orange);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.5;
        }
        
        .custom-prompt-card textarea {
            width: 100%;
            padding: 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        .custom-prompt-card textarea::placeholder {
            color: var(--text-muted);
        }
        
        .custom-prompt-card textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--surface-hover);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2);
        }
        
        /* Analysis Button */
        .btn-run-analysis {
            width: 100%;
            padding: 16px 24px;
            background: var(--gradient-orange);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-run-analysis::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-run-analysis:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-run-analysis:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--glow-orange), 0 10px 30px rgba(255, 107, 53, 0.3);
        }
        
        .btn-run-analysis:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .insights-container {
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .insights-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .insights-container::-webkit-scrollbar-track {
            background: var(--surface-light);
            border-radius: 4px;
        }
        
        .insights-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        .insights-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        .insights-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        .insights-placeholder {
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
        }
        
        .insight-item {
            padding: 18px;
            background: var(--surface-light);
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            position: relative;
            animation: slideIn 0.3s ease;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .insight-item:hover {
            transform: translateX(5px);
            background: var(--surface-hover);
            box-shadow: var(--glow-subtle);
            border-color: var(--primary);
        }
        
        .insight-item.timecode {
            cursor: pointer;
            padding-left: 60px;
        }
        
        .insight-item .timecode-badge {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .insight-item.timecode:hover .timecode-badge {
            background: var(--primary-dark);
        }
        
        /* Clickable timestamp styles */
        .timecode-badge.clickable {
            position: relative !important;
            cursor: pointer;
            transition: all 0.2s ease;
            transform: none !important;
            top: auto !important;
            left: auto !important;
            display: inline-block;
        }
        
        .timecode-badge.clickable:hover {
            background: var(--primary-dark) !important;
            transform: scale(1.05) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .timecode-badge.clickable:active {
            transform: scale(0.98) !important;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .insight-item h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .insight-item p {
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.6;
            font-size: 0.95em;
        }
        
        /* Chat Section */
        .chat-section {
            background: var(--surface);
            border-radius: 20px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 600px;
            max-height: 80vh;
            position: relative;
            overflow: hidden;
        }
        
        .chat-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--primary) 50%, transparent 100%);
            opacity: 0.5;
        }
        
        @media (max-width: 768px) {
            .chat-section {
                height: 70vh;
                max-height: none;
            }
        }
        
        .chat-header {
            padding: 20px;
            background: var(--gradient-orange);
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            z-index: 2;
        }
        
        .chat-header::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        .chat-header h2 {
            font-size: 1.2em;
            font-weight: 600;
            color: white;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            padding-bottom: 80px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
            background: var(--surface);
            min-height: 0;
            height: calc(100% - 70px);
        }
        
        /* Custom scrollbar for chat */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        .chat-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
        }
        
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            animation: fadeIn 0.3s ease;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .message p {
            margin: 0;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .message p + p {
            margin-top: 12px;
        }
        
        @media (max-width: 768px) {
            .message {
                max-width: 90%;
            }
        }
        
        .message.user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
        }
        
        .message.ai {
            align-self: flex-start;
            background: var(--surface-light);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        /* Format timestamps in messages */
        .message .timestamp {
            color: var(--primary);
            font-weight: 600;
            font-family: 'Courier New', monospace;
            background: rgba(255, 107, 53, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            margin: 0 2px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .message .timestamp:hover {
            background: rgba(255, 107, 53, 0.25);
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
        }
        
        /* Format code blocks */
        .message code {
            background: var(--surface-hover);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--primary-light);
        }
        
        /* Format bold text */
        .message strong {
            font-weight: 600;
            color: var(--primary);
        }
        
        .chat-input {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            flex-shrink: 0;
            background: var(--surface);
            min-height: auto;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 2;
        }
        
        @media (max-width: 768px) {
            .chat-input {
                padding: 15px;
                gap: 8px;
            }
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            min-width: 0;
            color: var(--text-primary);
        }
        
        .chat-input input::placeholder {
            color: var(--text-muted);
        }
        
        @media (max-width: 768px) {
            .chat-input input {
                padding: 10px 12px;
                font-size: 13px;
            }
        }
        
        .chat-input input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .chat-input button {
            padding: 12px 24px;
            background: var(--gradient-orange);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
        }
        
        .chat-input button:hover {
            transform: scale(1.05);
            box-shadow: var(--glow-subtle);
        }
        
        /* Loading States */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        /* Example Video Buttons */
        .example-video-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .example-video-btn:hover {
            background: rgba(255, 107, 53, 0.15);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
        }
        
        .example-video-btn i {
            font-size: 1em;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-status" id="loadingStatus">Preparing your video...</div>
            <div class="loading-message" id="loadingMessage">Please wait while we process your request</div>
            <div class="loading-progress">
                <div class="loading-progress-bar">
                    <span></span>
                    <!-- SVG definitions for wave shapes -->
                    <svg style="position: absolute; width: 0; height: 0;">
                        <defs>
                            <clipPath id="wave1">
                                <path d="M0,50 C150,20 350,80 500,50 C650,20 850,80 1000,50 C1150,20 1350,80 1500,50 L1500,100 L0,100 Z" />
                            </clipPath>
                            <clipPath id="wave2">
                                <path d="M0,60 C200,30 400,70 600,60 C800,50 1000,70 1200,60 C1400,50 1600,70 1800,60 L1800,100 L0,100 Z" />
                            </clipPath>
                            <clipPath id="wave3">
                                <path d="M0,40 C100,60 300,20 500,40 C700,60 900,20 1100,40 C1300,60 1500,20 1700,40 L1700,100 L0,100 Z" />
                            </clipPath>
                        </defs>
                    </svg>
                </div>
            </div>
            <div class="loading-steps">
                <div class="loading-step" id="step-download">
                    <div class="loading-step-icon">
                        <i class="bi bi-download"></i>
                    </div>
                    <div class="loading-step-label">Download</div>
                </div>
                <div class="loading-step" id="step-process">
                    <div class="loading-step-icon">
                        <i class="bi bi-gear"></i>
                    </div>
                    <div class="loading-step-label">Process</div>
                </div>
                <div class="loading-step" id="step-analyze">
                    <div class="loading-step-icon">
                        <i class="bi bi-stars"></i>
                    </div>
                    <div class="loading-step-label">Analyze</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>Video Intelligence</h1>
            <p>Advanced Video Intelligence & Real-time Analysis</p>
        </div>
        
        <!-- URL/Upload Input -->
        <div class="input-section centered" id="inputSection">
            <div id="alert" class="alert"></div>
            
            <!-- Input Type Selector -->
            <div class="input-type-selector" style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                <button class="input-type-btn active" onclick="switchInputType('url')" data-type="url" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                    <i class="bi bi-link-45deg"></i> YouTube URL
                </button>
                <button class="input-type-btn" onclick="switchInputType('upload')" data-type="upload" style="padding: 10px 20px; background: var(--surface-light); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                    <i class="bi bi-cloud-upload"></i> Upload Video
                </button>
            </div>
            
            <!-- URL Input Form -->
            <form id="analyzeForm" class="input-form" data-type="url">
                <div class="video-input-container">
                    <div class="video-input-wrapper">
                        <i class="bi bi-link-45deg input-icon"></i>
                        <input type="url" 
                               id="videoUrl" 
                               class="video-input"
                               placeholder="Paste YouTube video URL here..." 
                               required>
                        <button type="submit" class="btn-analyze-modern">
                            <i class="bi bi-play-circle-fill"></i>
                            <span>Analyze</span>
                        </button>
                    </div>
                </div>
            </form>
            
            <!-- File Upload Form -->
            <form id="uploadForm" class="input-form" data-type="upload" style="display: none;">
                <div class="video-input-container">
                    <div class="upload-area" style="border: 2px dashed var(--border); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s;" 
                         onclick="document.getElementById('videoFile').click();"
                         ondrop="handleDrop(event);" 
                         ondragover="handleDragOver(event);" 
                         ondragleave="handleDragLeave(event);">
                        <i class="bi bi-cloud-upload" style="font-size: 48px; color: var(--primary); margin-bottom: 10px; display: block;"></i>
                        <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 10px;">Drag and drop your video here or click to browse</p>
                        <p style="color: rgba(255, 255, 255, 0.5); font-size: 0.9em;">Supported formats: MP4, AVI, MOV, MKV, WEBM (Max 500MB)</p>
                        <input type="file" 
                               id="videoFile" 
                               accept="video/*,.mp4,.avi,.mov,.mkv,.webm"
                               style="display: none;"
                               onchange="handleFileSelect(event);">
                    </div>
                    <div id="fileInfo" style="margin-top: 15px; display: none;">
                        <div style="background: var(--surface-light); padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="bi bi-file-earmark-play" style="font-size: 24px; color: var(--primary);"></i>
                                <div>
                                    <p id="fileName" style="margin: 0; font-weight: 500;"></p>
                                    <p id="fileSize" style="margin: 0; font-size: 0.85em; color: rgba(255, 255, 255, 0.6);"></p>
                                </div>
                            </div>
                            <button type="button" onclick="clearFileSelection()" style="background: none; border: none; color: var(--error); cursor: pointer; padding: 5px;">
                                <i class="bi bi-x-circle" style="font-size: 20px;"></i>
                            </button>
                        </div>
                        <button type="submit" class="btn-analyze-modern" style="width: 100%; margin-top: 15px;">
                            <i class="bi bi-play-circle-fill"></i>
                            <span>Analyze Video</span>
                        </button>
                    </div>
                </div>
            </form>
            
            <!-- Example Videos -->
            <div style="margin-top: 20px; text-align: center;">
                <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.9em; margin-bottom: 12px;">
                    <i class="bi bi-lightbulb"></i> Try these example videos:
                </p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="loadExampleVideo('https://www.youtube.com/watch?v=Ata9cSC2WpM')" 
                            class="example-video-btn"
                            title="Angular in 100 Seconds">
                        <i class="bi bi-play-circle"></i> Angular Tutorial
                    </button>
                    <button onclick="loadExampleVideo('https://www.youtube.com/watch?v=8eVXTyIZ1Hs')" 
                            class="example-video-btn"
                            title="What Is Agile Methodology?">
                        <i class="bi bi-play-circle"></i> What Is Agile Methodology?
                    </button>
                    <button onclick="loadExampleVideo('https://www.youtube.com/watch?v=YysKbNk1tj0')" 
                            class="example-video-btn"
                            title="How to start with React native">
                        <i class="bi bi-play-circle"></i> How to start with React Native
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content Grid -->
        <div class="content-grid" id="mainContent" style="display: none;">
            <!-- Video Section -->
            <div class="video-section">
                <div class="video-container" id="videoContainer">
                    <video id="videoPlayer" style="display: none;"></video>
                    
                    <!-- Play Overlay -->
                    <div class="play-overlay" id="playOverlay" style="display: none;">
                        <i class="bi bi-play-fill"></i>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div class="video-loading" id="videoLoadingSpinner">
                        <div class="video-spinner"></div>
                    </div>
                    
                    <div class="video-placeholder" id="videoPlaceholder">
                        <i class="bi bi-play-circle"></i>
                        <p>Video will appear here</p>
                    </div>
                    
                    <!-- Custom Controls -->
                    <div class="video-controls" id="videoControls" style="display: none;">
                        <button class="play-btn" id="playBtn">
                            <i class="bi bi-play-fill"></i>
                        </button>
                        
                        <div class="time-display">
                            <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
                        </div>
                        
                        <div class="progress-bar" id="progressBar">
                            <div class="progress-filled" id="progressFilled"></div>
                        </div>
                        
                        <div class="volume-control">
                            <button class="volume-btn" id="volumeBtn">
                                <i class="bi bi-volume-up-fill"></i>
                            </button>
                            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="100">
                        </div>
                        
                        <div class="speed-selector">
                            <button class="speed-btn" id="speedBtn">1x</button>
                            <div class="speed-options" id="speedOptions">
                                <div class="speed-option" data-speed="0.5">0.5x</div>
                                <div class="speed-option" data-speed="0.75">0.75x</div>
                                <div class="speed-option active" data-speed="1">1x</div>
                                <div class="speed-option" data-speed="1.25">1.25x</div>
                                <div class="speed-option" data-speed="1.5">1.5x</div>
                                <div class="speed-option" data-speed="2">2x</div>
                            </div>
                        </div>
                        
                        <button class="control-btn" id="pipBtn">
                            <i class="bi bi-pip"></i>
                        </button>
                        
                        <button class="control-btn" id="fullscreenBtn">
                            <i class="bi bi-fullscreen"></i>
                        </button>
                    </div>
                    
                    <!-- Video Timeline with Markers -->
                    <div class="video-timeline" id="videoTimeline" style="display: none;">
                        <div class="video-timeline-progress" id="timelineProgress"></div>
                    </div>
                    
                    <!-- Chapters Toggle Button -->
                    <button class="toggle-chapters" id="toggleChapters" style="display: none;" onclick="toggleChapters()">
                        <i class="bi bi-list-ul"></i> Chapters
                    </button>
                    
                    <!-- Video Chapters Panel -->
                    <div class="video-chapters" id="videoChapters">
                        <h4><i class="bi bi-bookmark-fill"></i> Video Chapters</h4>
                        <div id="chaptersList"></div>
                    </div>
                </div>
                <div class="video-info" id="videoInfo" style="display: none;">
                    <div class="video-title" id="videoTitle"></div>
                    <div class="video-meta" id="videoMeta"></div>
                </div>
            </div>
            
            <!-- AI Analysis Section -->
            <div class="analysis-section" id="analysisSection" style="display: none;">
                <div class="section-header">
                    <h2>
                        <i class="bi bi-stars"></i>
                        AI Video Analysis
                    </h2>
                    <div id="analysisStatus" style="display: none;">
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                            <i class="bi bi-check-circle"></i> Ready
                        </span>
                    </div>
                </div>
                
                <div class="analysis-body">
                    <!-- Analysis Mode Selector -->
                    <div id="modeSelector" style="display: none;">
                        <div style="margin-bottom: 16px;">
                            <h3 style="font-size: 1.1em; font-weight: 600; color: rgba(255, 255, 255, 0.9); margin-bottom: 12px;">Choose Analysis Type</h3>
                            <div class="mode-pills">
                                <button class="mode-pill active" data-mode="summary" onclick="selectMode('summary')">
                                    <span class="material-icons-outlined">summarize</span> Summary
                                </button>
                                <button class="mode-pill" data-mode="key_moments" onclick="selectMode('key_moments')">
                                    <span class="material-icons-outlined">star</span> Key Moments
                                </button>
                                <button class="mode-pill" data-mode="transcript" onclick="selectMode('transcript')">
                                    <span class="material-icons-outlined">subtitles</span> Transcript
                                </button>
                                <button class="mode-pill" data-mode="objects" onclick="selectMode('objects')">
                                    <span class="material-icons-outlined">visibility</span> Objects
                                </button>
                                <button class="mode-pill" data-mode="sentiment" onclick="selectMode('sentiment')">
                                    <span class="material-icons-outlined">sentiment_satisfied</span> Sentiment
                                </button>
                                <button class="mode-pill" data-mode="educational" onclick="selectMode('educational')">
                                    <span class="material-icons-outlined">school</span> Educational
                                </button>
                                <button class="mode-pill" data-mode="custom" onclick="selectMode('custom')">
                                    <span class="material-icons-outlined">tune</span> Custom
                                </button>
                            </div>
                        </div>
                        
                        <div id="customPromptContainer" class="custom-prompt-card" style="display: none;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: rgba(255, 255, 255, 0.9);">
                                <i class="bi bi-pencil-square"></i> Custom Analysis Prompt
                            </label>
                            <textarea id="customPrompt" 
                                      placeholder="Describe what you want to analyze about this video..."
                                      rows="4"></textarea>
                        </div>
                        
                        <button class="btn-run-analysis" onclick="runAnalysis()" id="runAnalysisBtn">
                            <i class="bi bi-play-circle-fill"></i>
                            <span>Run Analysis</span>
                        </button>
                    </div>
                    
                    <div class="insights-container" id="insightsContainer">
                        <div class="insights-placeholder">
                            <i class="bi bi-lightbulb" style="font-size: 2.5em; color: rgba(255, 255, 255, 0.5);"></i>
                            <p style="color: rgba(255, 255, 255, 0.6); margin-top: 10px;">AI analysis will appear here after processing the video</p>
                        </div>
                    </div>
                    
                    <div class="loading" id="analysisLoading">
                        <div class="spinner"></div>
                        <p>Analyzing video content...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Section -->
        <div class="chat-section" id="chatSection" style="display: none;">
            <div class="chat-header">
                <i class="bi bi-chat-dots-fill" style="color: var(--primary);"></i>
                <h2>Ask About This Video</h2>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-placeholder">
                    <div>
                        <i class="bi bi-chat-square-text" style="font-size: 2em; color: #ccc;"></i>
                        <p>Chat will be available after video analysis</p>
                    </div>
                </div>
            </div>
            <div class="chat-input" id="chatInput" style="display: none;">
                <input type="text" 
                       id="chatMessage" 
                       placeholder="Ask a question about the video..."
                       disabled>
                <button onclick="sendMessage()" disabled>
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        let currentVideo = null;
        let chatHistory = [];
        let videoMarkers = [];
        let currentChapterIndex = -1;
        
        // Form submit - use the complete flow
        document.getElementById('analyzeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await processVideoComplete();
        });
        
        // Upload form submit
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await uploadAndAnalyzeVideo();
        });
        
        // Video player event listeners
        document.getElementById('videoPlayer').addEventListener('loadedmetadata', function() {
            setupVideoTimeline();
        });
        
        document.getElementById('videoPlayer').addEventListener('timeupdate', function() {
            updateTimelineProgress();
            updateActiveChapter();
        });
        
        // Timeline click handler
        document.getElementById('videoTimeline').addEventListener('click', function(e) {
            if (e.target.classList.contains('timeline-marker')) return;
            
            const rect = this.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const percentage = clickX / rect.width;
            const video = document.getElementById('videoPlayer');
            
            if (video && video.duration) {
                video.currentTime = percentage * video.duration;
            }
        });
        
        // Enter key in chat
        document.getElementById('chatMessage').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Mode selection
        let selectedMode = 'summary';
        
        function selectMode(mode) {
            selectedMode = mode;
            
            // Update pill states
            document.querySelectorAll('.mode-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // Show/hide custom prompt
            const customContainer = document.getElementById('customPromptContainer');
            if (mode === 'custom') {
                customContainer.style.display = 'block';
            } else {
                customContainer.style.display = 'none';
            }
        }
        
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = 'alert alert-' + type;
            alert.innerHTML = message;
            alert.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }
        }
        
        function loadExampleVideo(url) {
            document.getElementById('videoUrl').value = url;
            // Optional: auto-submit the form
            document.getElementById('analyzeForm').dispatchEvent(new Event('submit'));
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // File upload handling functions
        let selectedFile = null;
        
        function switchInputType(type) {
            // Update button states
            document.querySelectorAll('.input-type-btn').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                    btn.style.background = 'var(--primary)';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = 'var(--surface-light)';
                }
            });
            
            // Show/hide forms
            document.querySelectorAll('.input-form').forEach(form => {
                if (form.dataset.type === type) {
                    form.style.display = 'block';
                } else {
                    form.style.display = 'none';
                }
            });
            
            // Clear any alerts
            document.getElementById('alert').style.display = 'none';
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                validateAndShowFile(file);
            }
        }
        
        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const uploadArea = event.currentTarget;
            uploadArea.style.borderColor = 'var(--border)';
            uploadArea.style.background = 'transparent';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                validateAndShowFile(files[0]);
            }
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const uploadArea = event.currentTarget;
            uploadArea.style.borderColor = 'var(--primary)';
            uploadArea.style.background = 'rgba(76, 175, 80, 0.1)';
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const uploadArea = event.currentTarget;
            uploadArea.style.borderColor = 'var(--border)';
            uploadArea.style.background = 'transparent';
        }
        
        function validateAndShowFile(file) {
            // Check file type
            const validTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-matroska', 'video/webm'];
            const extension = file.name.split('.').pop().toLowerCase();
            const validExtensions = ['mp4', 'avi', 'mov', 'mkv', 'webm'];
            
            if (!validTypes.includes(file.type) && !validExtensions.includes(extension)) {
                showAlert('Please select a valid video file (MP4, AVI, MOV, MKV, WEBM)', 'error');
                return;
            }
            
            // Check file size (500MB limit)
            const maxSize = 500 * 1024 * 1024; // 500MB in bytes
            if (file.size > maxSize) {
                showAlert('File size exceeds 500MB limit', 'error');
                return;
            }
            
            // Store file and show info
            selectedFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').style.display = 'block';
            
            // Hide upload area
            document.querySelector('.upload-area').style.display = 'none';
        }
        
        function clearFileSelection() {
            selectedFile = null;
            document.getElementById('videoFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.querySelector('.upload-area').style.display = 'block';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function displayVideoInfo(info) {
            // Display video information in the UI
            if (!info) return;
            
            const titleElement = document.getElementById('videoTitle');
            const metaElement = document.getElementById('videoMeta');
            
            if (titleElement) {
                titleElement.innerHTML = `<i class="bi bi-play-circle"></i> ${info.title || 'Uploaded Video'}`;
            }
            
            if (metaElement) {
                const duration = info.duration || 0;
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                const durationStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                let metaHtml = `<span><i class="bi bi-clock"></i> ${durationStr}</span>`;
                
                if (info.width && info.height) {
                    metaHtml += ` <span><i class="bi bi-aspect-ratio"></i> ${info.width}x${info.height}</span>`;
                }
                
                if (info.fps) {
                    metaHtml += ` <span><i class="bi bi-speedometer2"></i> ${Math.round(info.fps)}fps</span>`;
                }
                
                if (info.codec) {
                    metaHtml += ` <span><i class="bi bi-file-code"></i> ${info.codec.toUpperCase()}</span>`;
                }
                
                metaElement.innerHTML = metaHtml;
            }
            
            // Show the video info section
            const videoInfoSection = document.getElementById('videoInfo');
            if (videoInfoSection) {
                videoInfoSection.style.display = 'block';
            }
        }
        
        async function uploadAndAnalyzeVideo() {
            if (!selectedFile) {
                showAlert('Please select a video file', 'error');
                return;
            }
            
            // Show loading overlay - same as YouTube flow
            showLoading('Uploading video...', 'Please wait while we upload your video');
            updateLoadingStep('download', 'active');
            startMessageRotation('download');
            
            try {
                // Step 1: Upload video
                const formData = new FormData();
                formData.append('video', selectedFile);
                
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('Upload failed');
                }
                
                const uploadData = await uploadResponse.json();
                
                if (!uploadData.success) {
                    throw new Error(uploadData.error || 'Upload failed');
                }
                
                // Store video data (same as download flow)
                currentVideo = uploadData;
                currentVideo.filename = uploadData.filename;  // Ensure filename is set in currentVideo
                currentVideoFile = uploadData.filename;
                
                // Update loading state
                updateLoadingStep('download', 'completed');
                updateLoadingStep('process', 'active');
                showLoading('Processing video...', 'Preparing your video for analysis');
                startMessageRotation('process');
                
                // Fetch transcription and wait for it
                if (uploadData.filename) {
                    const transcription = await fetchTranscription(uploadData.filename);
                    if (transcription && currentVideo) {
                        currentVideo.transcription = transcription;
                        console.log('Transcription ready for chat');
                    } else {
                        console.warn('No transcription available - chat may be limited');
                        // Set a placeholder or empty transcription
                        if (currentVideo) {
                            currentVideo.transcription = '';
                        }
                    }
                }
                
                // Wait a bit for visual effect
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Step 2: Analyze video
                updateLoadingStep('process', 'completed');
                updateLoadingStep('analyze', 'active');
                showLoading('Analyzing video...', 'AI is processing your video');
                startMessageRotation('analyze');
                
                const analyzeResponse = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: uploadData.filename,
                        mode: 'summary'
                    })
                });
                
                const analyzeData = await analyzeResponse.json();
                
                if (!analyzeData.success) {
                    throw new Error(analyzeData.error || 'Analysis failed');
                }
                
                // Store analysis result
                currentVideo.analysis = analyzeData.result;
                
                // Complete loading
                updateLoadingStep('analyze', 'completed');
                showLoading('Almost ready...', 'Preparing your results');
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Hide loading overlay and show main content (same as YouTube flow)
                hideLoading();
                document.getElementById('inputSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'grid';
                
                // Load video player
                const videoPlayer = document.getElementById('videoPlayer');
                videoPlayer.src = `/stream/${uploadData.filename}`;
                videoPlayer.style.display = 'block';
                document.getElementById('videoPlaceholder').style.display = 'none';
                
                // Initialize custom video controls
                setTimeout(initializeVideoControls, 100);
                
                // Show video info
                if (uploadData.video_info) {
                    displayVideoInfo(uploadData.video_info);
                }
                
                // Show analysis section with animation
                const analysisSection = document.getElementById('analysisSection');
                if (analysisSection) {
                    analysisSection.style.display = 'block';
                    analysisSection.classList.add('fade-in');
                }
                
                // Show analysis mode selector
                document.getElementById('modeSelector').style.display = 'block';
                document.getElementById('analysisLoading').style.display = 'none';
                
                // Display the initial analysis results
                displayAnalysisResults(analyzeData.result);
                
                // Update UI state
                document.getElementById('analysisStatus').style.display = 'inline-block';
                
                // Enable all mode pills
                document.querySelectorAll('.mode-pill').forEach(btn => {
                    btn.disabled = false;
                });
                
                // Show chat section after analysis is complete
                const chatSection = document.getElementById('chatSection');
                if (chatSection) {
                    setTimeout(() => {
                        chatSection.style.display = 'block';
                        chatSection.classList.add('fade-in');
                        enableChat();
                    }, 300);
                }
                
                // Clear file selection for next upload
                clearFileSelection();
                
                // Show success message
                showAlert('<i class="bi bi-check-circle"></i> Video uploaded and analyzed successfully!', 'success');
                
            } catch (error) {
                hideLoading();
                showAlert(`<i class="bi bi-exclamation-triangle"></i> ${error.message}`, 'error');
                console.error('Upload/Analysis error:', error);
            }
        }
        
        async function analyzeVideo() {
            const url = document.getElementById('videoUrl').value;
            
            if (!url) {
                showAlert('Please enter a YouTube URL', 'error');
                return;
            }
            
            // Reset UI
            document.getElementById('alert').style.display = 'none';
            document.getElementById('analysisLoading').style.display = 'block';
            document.getElementById('insightsContainer').innerHTML = '';
            
            showAlert('<i class="bi bi-download"></i> Downloading and processing video...', 'info');
            
            try {
                // Download video
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url })
                });
                
                const data = await response.json();
                
                // Check for YouTube bot detection error
                if (response.status === 429 && data.error) {
                    showAlert(
                        `<i class="bi bi-exclamation-triangle"></i> 
                        <strong>YouTube Authentication Required</strong><br>
                        ${data.error}<br><br>
                        <strong>Suggestion:</strong> ${data.suggestion || 'Try a different video or wait a few minutes.'}`,
                        'warning'
                    );
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('analyzeBtn').innerHTML = '<i class="bi bi-play-circle"></i> Analyze Video';
                    return;
                }
                
                if (data.success) {
                    currentVideo = data;
                    
                    // Store YouTube transcript status
                    currentVideo.hasYoutubeTranscript = data.has_youtube_transcript || false;
                    
                    // Log YouTube transcript status
                    console.log('===========================================');
                    console.log('VIDEO DOWNLOAD COMPLETE');
                    console.log('===========================================');
                    console.log(`Video: ${data.video_info?.title || data.filename}`);
                    console.log(`YouTube Transcript Available: ${data.has_youtube_transcript ? 'YES' : 'NO'}`);
                    if (data.has_youtube_transcript) {
                        console.log(`Transcript Language: ${data.transcript_language || 'auto-detected'}`);
                        console.log('Performance: Using YouTube transcript for instant analysis');
                        console.log('Status: Transcript cached on server');
                    } else {
                        console.log('No YouTube transcript found');
                        console.log('Will generate transcript from video when needed');
                    }
                    console.log('===========================================');
                    
                    // Remove centered class from input section
                    document.getElementById('inputSection').classList.remove('centered');
                    
                    // Show main content with fade-in animation
                    const mainContent = document.getElementById('mainContent');
                    mainContent.style.display = 'grid';
                    mainContent.classList.add('fade-in');
                    
                    // Show video
                    const videoPlayer = document.getElementById('videoPlayer');
                    videoPlayer.src = `/stream/${data.filename}`;
                    videoPlayer.style.display = 'block';
                    
                    // Initialize custom video controls
                    setTimeout(initializeVideoControls, 100);
                    
                    // Show message based on transcript status
                    if (data.transcript_blocked) {
                        console.log(' YouTube transcript API blocked:', data.blocked_reason);
                        showAlert(`<i class="bi bi-exclamation-triangle"></i> YouTube transcript API blocked by YouTube (common in Docker/WSL). Will generate transcript from video.`, 'warning');
                        // Fetch transcription since YouTube is blocked
                        console.log(' Fetching video transcription from /transcribe endpoint...');
                        fetchTranscription(data.filename);
                    } else if (data.has_youtube_transcript) {
                        showAlert(`<i class="bi bi-check-circle"></i> YouTube transcript found (${data.transcript_language || 'auto'}) - Using for faster analysis!`, 'success');
                        // YouTube transcript is already cached on server, no need to fetch
                        console.log(' Skipping /transcribe call - using cached YouTube transcript');
                    } else {
                        // Only fetch transcription if no YouTube transcript
                        console.log(' Fetching video transcription from /transcribe endpoint...');
                        fetchTranscription(data.filename);
                    }
                    
                    document.getElementById('videoPlaceholder').style.display = 'none';
                    
                    // Show video info
                    if (data.video_info) {
                        const info = data.video_info;
                        document.getElementById('videoTitle').textContent = info.title || 'Untitled Video';
                        
                        const duration = info.duration ? 
                            `${Math.floor(info.duration/60)}:${(info.duration%60).toString().padStart(2, '0')}` : 
                            'N/A';
                        
                        document.getElementById('videoMeta').innerHTML = `
                            <span><i class="bi bi-person-circle"></i> ${info.uploader || 'Unknown'}</span>
                            <span><i class="bi bi-eye"></i> ${(info.view_count || 0).toLocaleString()} views</span>
                            <span><i class="bi bi-clock"></i> ${duration}</span>
                        `;
                        
                        document.getElementById('videoInfo').style.display = 'block';
                    }
                    
                    // Show analysis section with animation
                    setTimeout(() => {
                        // Show analysis section
                        const analysisSection = document.getElementById('analysisSection');
                        if (analysisSection) {
                            analysisSection.style.display = 'block';
                            analysisSection.classList.add('fade-in');
                        }
                        
                        // Show analysis mode selector
                        document.getElementById('modeSelector').style.display = 'block';
                        document.getElementById('analysisLoading').style.display = 'none';
                        
                        // Don't show chat yet - wait for analysis to complete
                        
                        // Run initial analysis after elements are visible
                        setTimeout(async () => {
                            await runAnalysis();
                        }, 300);
                    }, 500);
                    showAlert('<i class="bi bi-check-circle"></i> Video ready for analysis!', 'success');
                    
                    // Clear URL input
                    document.getElementById('videoUrl').value = '';
                    
                } else {
                    showAlert(`<i class="bi bi-x-circle"></i> Error: ${data.error}`, 'error');
                    document.getElementById('analysisLoading').style.display = 'none';
                }
            } catch (error) {
                showAlert(`<i class="bi bi-x-circle"></i> Error: ${error.message}`, 'error');
                document.getElementById('analysisLoading').style.display = 'none';
            }
        }
        
        async function fetchTranscription(filename) {
            try {
                const response = await fetch('/transcribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: filename
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.transcription) {
                    console.log('Transcription loaded:', data.cached ? 'from cache' : 'fresh');
                    // Store transcription for later use in chat
                    if (currentVideo) {
                        currentVideo.transcription = data.transcription;
                    }
                    return data.transcription;
                } else if (!data.success) {
                    console.warn('Transcription failed:', data.error || 'Unknown error');
                    // Return empty transcription or show warning
                    if (data.error && data.error.includes('API not configured')) {
                        console.log('Using mock transcription due to missing API configuration');
                    }
                }
                return null;
            } catch (error) {
                console.error('Failed to fetch transcription:', error);
                return null;
            }
        }
        
        async function runAnalysis() {
            if (!currentVideo) return;
            
            const mode = selectedMode;
            const customPrompt = document.getElementById('customPrompt').value;
            
            // Update button state
            const btn = document.getElementById('runAnalysisBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> <span>Analyzing...</span>';
            
            document.getElementById('analysisLoading').style.display = 'block';
            document.getElementById('insightsContainer').innerHTML = '';
            
            // Log analysis info
            console.log('===========================================');
            console.log('STARTING VIDEO ANALYSIS');
            console.log('===========================================');
            console.log(`Analysis Mode: ${mode}`);
            console.log(`Has YouTube Transcript: ${currentVideo.hasYoutubeTranscript ? 'YES' : 'NO'}`);
            if (currentVideo.hasYoutubeTranscript) {
                console.log('Using YouTube transcript for fast analysis');
            } else {
                console.log('Will analyze video frames directly');
            }
            console.log('===========================================');
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: currentVideo.filename,
                        mode: mode,
                        custom_prompt: mode === 'custom' ? customPrompt : null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Log analysis completion
                    console.log('ANALYSIS COMPLETE');
                    if (data.source === 'youtube_transcript') {
                        console.log('Source: YouTube Transcript (Fast)');
                    } else if (data.cached) {
                        console.log('Source: Cached Result');
                    } else {
                        console.log('Source: Video Analysis');
                    }
                    
                    displayAnalysisResults(data.result);
                    
                    // Update status
                    const status = document.getElementById('analysisStatus');
                    status.style.display = 'block';
                    status.innerHTML = `
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                            <i class="bi bi-check-circle"></i> ${getModeLabel(mode)} Complete
                        </span>
                    `;
                    
                    // Show chat section after analysis is complete
                    const chatSection = document.getElementById('chatSection');
                    if (chatSection && chatSection.style.display === 'none') {
                        setTimeout(() => {
                            chatSection.style.display = 'block';
                            chatSection.classList.add('fade-in');
                            enableChat();
                        }, 300);
                    }
                } else {
                    showAlert(`<i class="bi bi-x-circle"></i> Analysis error: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert(`<i class="bi bi-x-circle"></i> Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('analysisLoading').style.display = 'none';
                
                // Reset button
                const btn = document.getElementById('runAnalysisBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-play-circle-fill"></i> <span>Run Analysis</span>';
            }
        }
        
        function getModeLabel(mode) {
            const labels = {
                'summary': 'Summary',
                'key_moments': 'Key Moments',
                'transcript': 'Transcript',
                'objects': 'Objects',
                'sentiment': 'Sentiment',
                'educational': 'Educational',
                'custom': 'Custom'
            };
            return labels[mode] || mode;
        }
        
        function displayAnalysisResults(result) {
            const container = document.getElementById('insightsContainer');
            container.innerHTML = '';
            videoMarkers = []; // Reset markers
            
            console.log('Displaying analysis results:', result);
            
            // Check if result has analysis object (new format from real API)
            if (result.analysis) {
                let analysis = result.analysis;
                
                // Handle nested analysis structure from Gemini API
                if (typeof analysis.analysis === 'string') {
                    // Parse JSON from markdown code block
                    try {
                        // Extract JSON from markdown code block if present
                        const jsonMatch = analysis.analysis.match(/```json\n([\s\S]*?)\n```/);
                        if (jsonMatch) {
                            analysis = JSON.parse(jsonMatch[1]);
                            console.log('Parsed JSON from markdown:', analysis);
                        } else {
                            // Try direct parse if no markdown wrapper
                            analysis = JSON.parse(analysis.analysis);
                            console.log('Parsed direct JSON:', analysis);
                        }
                    } catch (e) {
                        console.error('Failed to parse analysis JSON:', e);
                        // Fallback to display as text
                        const textDiv = document.createElement('div');
                        textDiv.className = 'insight-item';
                        textDiv.innerHTML = `<pre style="white-space: pre-wrap; color: rgba(255, 255, 255, 0.85);">${analysis.analysis}</pre>`;
                        container.appendChild(textDiv);
                        return;
                    }
                } else if (typeof analysis === 'object' && analysis.analysis) {
                    // Double nested structure
                    analysis = analysis.analysis;
                }
                
                console.log('Final analysis object:', analysis);
                
                // Handle various nested structures from different modes
                // Sentiment mode - flatten sentiment_analysis structure
                if (analysis.sentiment_analysis) {
                    Object.assign(analysis, {
                        overall_sentiment: analysis.sentiment_analysis.overall_sentiment,
                        emotional_moments: analysis.sentiment_analysis.emotional_moments,
                        mood_changes: analysis.sentiment_analysis.mood_changes,
                        energy_variations: analysis.sentiment_analysis.energy_level_variations || analysis.sentiment_analysis.energy_variations
                    });
                    console.log('Flattened sentiment analysis structure');
                }
                
                // Objects mode - flatten objects_analysis or scenes_analysis structure
                if (analysis.objects_analysis) {
                    Object.assign(analysis, analysis.objects_analysis);
                    console.log('Flattened objects analysis structure');
                }
                if (analysis.scenes_analysis) {
                    Object.assign(analysis, analysis.scenes_analysis);
                    console.log('Flattened scenes analysis structure');
                }
                
                // Educational mode - flatten educational_content structure
                if (analysis.educational_content) {
                    Object.assign(analysis, analysis.educational_content);
                    console.log('Flattened educational content structure');
                }
                
                // Key moments - flatten key_moments_analysis structure
                if (analysis.key_moments_analysis) {
                    Object.assign(analysis, analysis.key_moments_analysis);
                    console.log('Flattened key moments structure');
                }
                
                // Transcript - flatten transcript_analysis structure
                if (analysis.transcript_analysis) {
                    Object.assign(analysis, analysis.transcript_analysis);
                    console.log('Flattened transcript structure');
                }
                
                // Summary - flatten summary_analysis structure
                if (analysis.summary_analysis) {
                    Object.assign(analysis, analysis.summary_analysis);
                    console.log('Flattened summary structure');
                }
                
                // Generic flattening - if there's only one top-level key that's an object
                // This handles any other nested structure patterns
                const keys = Object.keys(analysis);
                if (keys.length === 1 && typeof analysis[keys[0]] === 'object' && !Array.isArray(analysis[keys[0]])) {
                    const nestedData = analysis[keys[0]];
                    console.log(`Flattening single nested structure with key: ${keys[0]}`);
                    Object.assign(analysis, nestedData);
                }
                
                // Display summary if available
                if (analysis.summary) {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'insight-item';
                    summaryDiv.innerHTML = `
                        <h3 style="color: var(--primary); margin-bottom: 10px;">
                            <i class="bi bi-file-text"></i> Summary
                        </h3>
                        <p style="line-height: 1.8; color: rgba(255, 255, 255, 0.9);">${analysis.summary}</p>
                    `;
                    container.appendChild(summaryDiv);
                }
                
                // Display key topics if available
                if (analysis.key_topics && analysis.key_topics.length > 0) {
                    const topicsDiv = document.createElement('div');
                    topicsDiv.className = 'insight-item';
                    topicsDiv.innerHTML = `
                        <h3 style="color: var(--primary); margin-bottom: 10px;">
                            <i class="bi bi-tags"></i> Key Topics
                        </h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${analysis.key_topics.map(topic => 
                                `<span style="background: var(--surface-light); padding: 6px 12px; border-radius: 20px; font-size: 0.9em; color: rgba(255, 255, 255, 0.85); border: 1px solid var(--border);">
                                    ${topic}
                                </span>`
                            ).join('')}
                        </div>
                    `;
                    container.appendChild(topicsDiv);
                }
                
                // Display title if available
                if (analysis.title) {
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'insight-item';
                    titleDiv.innerHTML = `
                        <h2 style="color: var(--primary); margin-bottom: 10px; text-align: center;">
                            ${analysis.title}
                        </h2>
                    `;
                    container.appendChild(titleDiv);
                }
                
                // Display educational content if available
                if (analysis.learningObjectives) {
                    const eduDiv = document.createElement('div');
                    eduDiv.className = 'insight-item';
                    eduDiv.innerHTML = `
                        <h3 style="color: var(--primary); margin-bottom: 10px;">
                            <i class="bi bi-mortarboard"></i> Learning Objectives
                        </h3>
                        <ul style="color: rgba(255, 255, 255, 0.85); line-height: 1.8;">
                            ${analysis.learningObjectives.map(obj => `<li>${obj}</li>`).join('')}
                        </ul>
                    `;
                    container.appendChild(eduDiv);
                }
                
                // Display main concepts for educational mode
                if (analysis.mainConcepts && analysis.mainConcepts.length > 0) {
                    const conceptsDiv = document.createElement('div');
                    conceptsDiv.className = 'insight-item';
                    
                    // Check if mainConcepts is array of strings or objects
                    const isStringArray = typeof analysis.mainConcepts[0] === 'string';
                    
                    if (isStringArray) {
                        // Handle array of strings
                        conceptsDiv.innerHTML = `
                            <h3 style="color: var(--primary); margin-bottom: 10px;">
                                <i class="bi bi-lightbulb"></i> Main Concepts
                            </h3>
                            <ul style="color: rgba(255, 255, 255, 0.85); line-height: 1.8;">
                                ${analysis.mainConcepts.map(concept => `<li>${concept}</li>`).join('')}
                            </ul>
                        `;
                        container.appendChild(conceptsDiv);
                    } else {
                        // Handle array of objects (original format)
                        analysis.mainConcepts.forEach((concept, index) => {
                            setTimeout(() => {
                                const conceptDiv = document.createElement('div');
                                conceptDiv.className = 'insight-item';
                                conceptDiv.innerHTML = `
                                    <h4 style="color: var(--primary); margin-bottom: 8px;">
                                        <i class="bi bi-lightbulb"></i> ${concept.concept}
                                    </h4>
                                    <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 8px;">
                                        ${concept.description}
                                    </p>
                                    ${concept.details ? `
                                        <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9em;">
                                            ${concept.details}
                                        </p>
                                    ` : ''}
                                    ${concept.examples ? `
                                        <div style="margin-top: 8px;">
                                            ${concept.examples.map(ex => `
                                                <div style="margin-left: 20px; color: rgba(255, 255, 255, 0.7); font-size: 0.9em;">
                                                     <strong>${ex.directive}:</strong> ${ex.description}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                `;
                                container.appendChild(conceptDiv);
                            }, index * 100);
                        });
                    }
                }
                
                // Display examples with code blocks
                if (analysis.examples && analysis.examples.length > 0) {
                    const examplesDiv = document.createElement('div');
                    examplesDiv.className = 'insight-item';
                    examplesDiv.innerHTML = `
                        <h3 style="color: var(--primary); margin-bottom: 15px;">
                            <i class="bi bi-code-slash"></i> Code Examples
                        </h3>
                    `;
                    
                    analysis.examples.forEach((example, index) => {
                        const exampleItem = document.createElement('div');
                        exampleItem.style.marginBottom = '20px';
                        
                        // Handle code as array or string
                        const codeContent = Array.isArray(example.code) 
                            ? example.code.join('\\n') 
                            : example.code;
                        
                        exampleItem.innerHTML = `
                            <div style="margin-bottom: 8px;">
                                <p style="color: rgba(255, 255, 255, 0.85); font-size: 0.9em; margin-bottom: 8px;">
                                    ${example.description}
                                </p>
                                <pre style="background: rgba(0, 0, 0, 0.4); padding: 12px; border-radius: 8px; 
                                           border: 1px solid rgba(255, 255, 255, 0.1); overflow-x: auto;">
                                    <code style="color: #f0f0f0; font-family: 'Fira Code', 'Monaco', monospace; font-size: 0.85em;">${escapeHtml(codeContent)}</code>
                                </pre>
                            </div>
                        `;
                        examplesDiv.appendChild(exampleItem);
                    });
                    
                    container.appendChild(examplesDiv);
                }
                
                // Display key takeaways
                if (analysis.keyTakeaways && analysis.keyTakeaways.length > 0) {
                    const takeawaysDiv = document.createElement('div');
                    takeawaysDiv.className = 'insight-item';
                    takeawaysDiv.innerHTML = `
                        <h3 style="color: var(--primary); margin-bottom: 10px;">
                            <i class="bi bi-check-circle"></i> Key Takeaways
                        </h3>
                        <ul style="color: rgba(255, 255, 255, 0.85); line-height: 1.8;">
                            ${analysis.keyTakeaways.map(takeaway => `<li>${takeaway}</li>`).join('')}
                        </ul>
                    `;
                    container.appendChild(takeawaysDiv);
                }
                
                // Display action items
                if (analysis.actionItems && analysis.actionItems.length > 0) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'insight-item';
                    actionsDiv.innerHTML = `
                        <h3 style="color: var(--primary); margin-bottom: 10px;">
                            <i class="bi bi-list-task"></i> Action Items
                        </h3>
                        <ul style="color: rgba(255, 255, 255, 0.85); line-height: 1.8;">
                            ${analysis.actionItems.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    `;
                    container.appendChild(actionsDiv);
                }
                
                // Display additional resources
                if (analysis.additionalResources || analysis.resources) {
                    const resourcesDiv = document.createElement('div');
                    resourcesDiv.className = 'insight-item';
                    const resources = analysis.additionalResources || analysis.resources;
                    
                    // Handle both string and array formats
                    const resourcesList = Array.isArray(resources) 
                        ? resources 
                        : resources.split(',').map(r => r.trim());
                    
                    resourcesDiv.innerHTML = `
                        <h3 style="color: var(--primary); margin-bottom: 10px;">
                            <i class="bi bi-link-45deg"></i> Additional Resources
                        </h3>
                        <ul style="color: rgba(255, 255, 255, 0.85); line-height: 1.8;">
                            ${resourcesList.map(resource => `
                                <li>
                                    ${resource.startsWith('http') 
                                        ? `<a href="${resource}" target="_blank" style="color: var(--primary); text-decoration: none; hover: underline;">${resource}</a>`
                                        : resource
                                    }
                                </li>
                            `).join('')}
                        </ul>
                    `;
                    container.appendChild(resourcesDiv);
                }
                
                // Display sentiment analysis
                if (analysis.overall_sentiment || analysis.emotional_moments || analysis.mood_changes || analysis.energy_variations) {
                    const sentimentDiv = document.createElement('div');
                    sentimentDiv.className = 'insight-item';
                    sentimentDiv.innerHTML = `
                        <h3 style="color: var(--primary); margin-bottom: 15px;">
                            <i class="bi bi-emoji-smile"></i> Sentiment Analysis
                        </h3>
                    `;
                    
                    if (analysis.overall_sentiment) {
                        const overallDiv = document.createElement('p');
                        overallDiv.style.cssText = 'color: rgba(255, 255, 255, 0.9); margin-bottom: 15px;';
                        overallDiv.innerHTML = `<strong>Overall Sentiment:</strong> ${analysis.overall_sentiment}`;
                        sentimentDiv.appendChild(overallDiv);
                    }
                    
                    // Display emotional moments with clickable timestamps
                    if (analysis.emotional_moments && analysis.emotional_moments.length > 0) {
                        const momentsContainer = document.createElement('div');
                        momentsContainer.style.marginTop = '10px';
                        
                        const momentsTitle = document.createElement('h4');
                        momentsTitle.style.cssText = 'color: rgba(255, 255, 255, 0.7); font-size: 0.9em; margin-bottom: 10px;';
                        momentsTitle.textContent = 'Emotional Moments:';
                        momentsContainer.appendChild(momentsTitle);
                        
                        analysis.emotional_moments.forEach((moment, index) => {
                            const timeStr = moment.timestamp || moment.time || '00:00';
                            const emotion = moment.emotion || 'Unknown';
                            const description = moment.description || '';
                            
                            // Create moment item div
                            const momentItem = document.createElement('div');
                            momentItem.className = 'emotion-item';
                            momentItem.style.cssText = `
                                margin-bottom: 8px; 
                                padding: 10px; 
                                background: rgba(255, 255, 255, 0.05); 
                                border-radius: 8px; 
                                border-left: 3px solid var(--primary); 
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                            `;
                            
                            // No hover effect on container - only on timestamp badge
                            
                            momentItem.innerHTML = `
                                <span class="timecode-badge clickable" 
                                      style="cursor: pointer; margin-right: 10px; background: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 0.85em; color: white; font-weight: 600;">
                                    ${timeStr}
                                </span>
                                <div style="flex: 1;">
                                    <div style="color: rgba(255, 255, 255, 0.85); font-weight: 600;">${emotion}</div>
                                    ${description ? `<div style="color: rgba(255, 255, 255, 0.6); font-size: 0.9em; margin-top: 4px;">${description}</div>` : ''}
                                </div>
                            `;
                            
                            // Add click handler to entire moment item
                            momentItem.onclick = (e) => {
                                e.stopPropagation();
                                console.log('Clicked emotional moment with time:', timeStr);
                                seekToTime(timeStr);
                            };
                            momentItem.title = 'Click to jump to ' + timeStr;
                            
                            // Add with animation delay
                            setTimeout(() => {
                                momentsContainer.appendChild(momentItem);
                            }, index * 50);
                        });
                        
                        sentimentDiv.appendChild(momentsContainer);
                    }
                    
                    // Display mood changes with clickable timestamps
                    if (analysis.mood_changes && analysis.mood_changes.length > 0) {
                        const moodContainer = document.createElement('div');
                        moodContainer.style.marginTop = '15px';
                        
                        const moodTitle = document.createElement('h4');
                        moodTitle.style.cssText = 'color: rgba(255, 255, 255, 0.7); font-size: 0.9em; margin-bottom: 10px;';
                        moodTitle.textContent = 'Mood Changes:';
                        moodContainer.appendChild(moodTitle);
                        
                        analysis.mood_changes.forEach((change, index) => {
                            const timeStr = change.timestamp || change.time || '00:00';
                            const mood = change.mood_change || change.mood || change.description || 'Unknown mood';
                            const description = change.description || '';
                            
                            const changeItem = document.createElement('div');
                            changeItem.className = 'mood-change-item';
                            changeItem.style.cssText = `
                                margin-bottom: 8px; 
                                padding: 10px; 
                                background: rgba(255, 255, 255, 0.05); 
                                border-radius: 8px; 
                                border-left: 3px solid #9c27b0; 
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                            `;
                            
                            // No hover effect on container - only on timestamp badge
                            
                            changeItem.innerHTML = `
                                <span class="timecode-badge clickable" 
                                      style="cursor: pointer; margin-right: 10px; background: #9c27b0; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; color: white; font-weight: 600;">
                                    ${timeStr}
                                </span>
                                <div style="flex: 1;">
                                    <div style="color: rgba(255, 255, 255, 0.85);">
                                        <i class="bi bi-arrow-right" style="margin: 0 5px;"></i> ${mood}
                                    </div>
                                    ${description ? `<div style="color: rgba(255, 255, 255, 0.6); font-size: 0.9em; margin-top: 4px; margin-left: 20px;">${description}</div>` : ''}
                                </div>
                            `;
                            
                            changeItem.onclick = (e) => {
                                e.stopPropagation();
                                console.log('Clicked mood change with time:', timeStr);
                                seekToTime(timeStr);
                            };
                            changeItem.title = 'Click to jump to ' + timeStr;
                            
                            setTimeout(() => {
                                moodContainer.appendChild(changeItem);
                            }, index * 50);
                        });
                        
                        sentimentDiv.appendChild(moodContainer);
                    }
                    
                    // Display energy level variations with clickable timestamps
                    if (analysis.energy_variations && analysis.energy_variations.length > 0) {
                        const energyContainer = document.createElement('div');
                        energyContainer.style.marginTop = '15px';
                        
                        const energyTitle = document.createElement('h4');
                        energyTitle.style.cssText = 'color: rgba(255, 255, 255, 0.7); font-size: 0.9em; margin-bottom: 10px;';
                        energyTitle.textContent = 'Energy Level Variations:';
                        energyContainer.appendChild(energyTitle);
                        
                        analysis.energy_variations.forEach((variation, index) => {
                            const timeStr = variation.timestamp || variation.time || '00:00';
                            const level = variation.energy_level || variation.level || variation.energy || 'Unknown';
                            const description = variation.description || '';
                            
                            const energyItem = document.createElement('div');
                            energyItem.className = 'energy-variation-item';
                            energyItem.style.cssText = `
                                margin-bottom: 8px; 
                                padding: 10px; 
                                background: rgba(255, 255, 255, 0.05); 
                                border-radius: 8px; 
                                border-left: 3px solid #ff9800; 
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                            `;
                            
                            // No hover effect on container - only on timestamp badge
                            
                            energyItem.innerHTML = `
                                <span class="timecode-badge clickable" 
                                      style="cursor: pointer; margin-right: 10px; background: #ff9800; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; color: white; font-weight: 600;">
                                    ${timeStr}
                                </span>
                                <div style="flex: 1;">
                                    <div style="color: rgba(255, 255, 255, 0.85);">
                                        <i class="bi bi-activity" style="margin-right: 5px;"></i> Energy: ${level}
                                    </div>
                                    ${description ? `<div style="color: rgba(255, 255, 255, 0.6); font-size: 0.9em; margin-top: 4px;">${description}</div>` : ''}
                                </div>
                            `;
                            
                            energyItem.onclick = (e) => {
                                e.stopPropagation();
                                console.log('Clicked energy variation with time:', timeStr);
                                seekToTime(timeStr);
                            };
                            energyItem.title = 'Click to jump to ' + timeStr;
                            
                            setTimeout(() => {
                                energyContainer.appendChild(energyItem);
                            }, index * 50);
                        });
                        
                        sentimentDiv.appendChild(energyContainer);
                    }
                    
                    container.appendChild(sentimentDiv);
                }
                
                // Display detected objects
                if (analysis.objects || analysis.scenes) {
                    const objectsDiv = document.createElement('div');
                    objectsDiv.className = 'insight-item';
                    objectsDiv.innerHTML = `
                        <h3 style="color: var(--primary); margin-bottom: 15px;">
                            <i class="bi bi-eye"></i> Detected Objects & Scenes
                        </h3>
                    `;
                    
                    if (analysis.scenes && analysis.scenes.length > 0) {
                        const scenesContainer = document.createElement('div');
                        scenesContainer.style.marginTop = '10px';
                        
                        analysis.scenes.forEach((scene, index) => {
                            setTimeout(() => {
                                const timeStr = scene.timestamp || scene.time || '00:00';
                                const location = scene.location || scene.setting || 'Scene';
                                
                                // Create scene item div
                                const sceneItem = document.createElement('div');
                                sceneItem.className = 'scene-item';
                                sceneItem.style.cssText = `
                                    margin-bottom: 12px; 
                                    padding: 12px; 
                                    background: rgba(255, 255, 255, 0.05); 
                                    border-radius: 8px; 
                                    border-left: 3px solid var(--primary); 
                                    cursor: pointer;
                                `;
                                
                                // Build HTML content
                                let sceneHtml = `
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <span class="timecode-badge clickable" 
                                              onclick="seekToTime('${timeStr.replace(/'/g, "\\'")}')"
                                              style="cursor: pointer; margin-right: 10px; background: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 0.85em; color: white; font-weight: 600;">
                                            ${timeStr}
                                        </span>
                                        <strong style="color: rgba(255, 255, 255, 0.9);">${location}</strong>
                                    </div>
                                `;
                                
                                if (scene.objects && scene.objects.length > 0) {
                                    sceneHtml += `
                                        <div style="margin-left: 20px; color: rgba(255, 255, 255, 0.7); font-size: 0.9em;">
                                            <i class="bi bi-box" style="margin-right: 5px;"></i>
                                            Objects: ${Array.isArray(scene.objects) ? scene.objects.join(', ') : scene.objects}
                                        </div>
                                    `;
                                }
                                
                                if (scene.people) {
                                    sceneHtml += `
                                        <div style="margin-left: 20px; color: rgba(255, 255, 255, 0.7); font-size: 0.9em;">
                                            <i class="bi bi-people" style="margin-right: 5px;"></i>
                                            People: ${scene.people}
                                        </div>
                                    `;
                                }
                                
                                sceneItem.innerHTML = sceneHtml;
                                sceneItem.title = 'Click to jump to ' + timeStr;
                                
                                // Add click handler to entire scene item
                                sceneItem.addEventListener('click', function(e) {
                                    // Don't trigger if clicking on the timestamp badge itself
                                    if (!e.target.classList.contains('timecode-badge')) {
                                        console.log('Clicked scene container with time:', timeStr);
                                        seekToTime(timeStr);
                                    }
                                });
                                
                                // Find the timestamp badge and ensure it has click handler
                                const badge = sceneItem.querySelector('.timecode-badge');
                                if (badge) {
                                    badge.style.cursor = 'pointer';
                                }
                                
                                scenesContainer.appendChild(sceneItem);
                            }, index * 50);
                        });
                        
                        objectsDiv.appendChild(scenesContainer);
                    } else if (analysis.objects && analysis.objects.length > 0) {
                        const objectsContainer = document.createElement('div');
                        objectsContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;';
                        objectsContainer.innerHTML = analysis.objects.map(obj => `
                            <span style="background: var(--surface-light); padding: 6px 12px; border-radius: 20px; font-size: 0.9em; color: rgba(255, 255, 255, 0.85); border: 1px solid var(--border);">
                                <i class="bi bi-tag" style="margin-right: 4px;"></i>${obj}
                            </span>
                        `).join('');
                        objectsDiv.appendChild(objectsContainer);
                    }
                    
                    container.appendChild(objectsDiv);
                }
                
                // Display transcript sections with clickable timestamps like key moments
                if (analysis.transcript && Array.isArray(analysis.transcript)) {
                    // Add transcript header
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'insight-item';
                    headerDiv.innerHTML = `
                        <h3 style="color: var(--primary); margin-bottom: 15px;">
                            <i class="bi bi-chat-text"></i> Transcript
                        </h3>
                    `;
                    container.appendChild(headerDiv);
                    
                    // Display each transcript entry as a separate clickable item
                    analysis.transcript.forEach((section, index) => {
                        setTimeout(() => {
                            const transcriptItem = document.createElement('div');
                            transcriptItem.className = 'insight-item timecode';
                            transcriptItem.style.cursor = 'pointer';
                            
                            // Get timestamp and text
                            const timestamp = section.timestamp || section.time || '00:00';
                            const speaker = section.speaker || '';
                            const text = section.text || section.content || '';
                            
                            transcriptItem.innerHTML = `
                                <span class="timecode-badge">${timestamp}</span>
                                <div style="flex: 1;">
                                    ${speaker ? `<strong style="color: var(--primary); font-size: 0.9em;">${speaker}:</strong>` : ''}
                                    <p style="line-height: 1.6; color: rgba(255, 255, 255, 0.85); margin-top: 4px;">
                                        ${text}
                                    </p>
                                </div>
                            `;
                            
                            // Add click handler for video seek
                            transcriptItem.onclick = () => {
                                console.log('Clicked transcript with time:', timestamp);
                                seekToTime(timestamp);
                            };
                            transcriptItem.title = 'Click to jump to ' + timestamp;
                            
                            container.appendChild(transcriptItem);
                        }, index * 50); // Stagger the appearance
                    });
                }
                
                // Display moments with clickable timestamps
                if (analysis.moments && analysis.moments.length > 0) {
                    // Store markers for timeline
                    videoMarkers = analysis.moments.map(moment => {
                        const timestamp = moment.timestamp || moment.time;
                        const startTime = timestamp ? timestamp.split('-')[0] : null;
                        return {
                            time: startTime,
                            description: moment.description || moment.text || '',
                            timestamp: timestamp
                        };
                    }).filter(m => m.time);
                    
                    // Update timeline and chapters
                    setupVideoTimeline();
                    updateChaptersList();
                    
                    analysis.moments.forEach((moment, index) => {
                        setTimeout(() => {
                            const div = document.createElement('div');
                            div.className = 'insight-item timecode';
                            div.style.cursor = 'pointer';
                            
                            // Parse timestamp (format: "0:00-0:06" or "0:00")
                            const timestamp = moment.timestamp || moment.time;
                            const startTime = timestamp ? timestamp.split('-')[0] : null;
                            
                            div.innerHTML = `
                                <span class="timecode-badge">${startTime || 'N/A'}</span>
                                <div style="flex: 1;">
                                    <p style="line-height: 1.6; color: rgba(255, 255, 255, 0.85);">
                                        ${moment.description || moment.text || ''}
                                    </p>
                                    ${timestamp && timestamp.includes('-') ? 
                                        `<p style="color: rgba(255, 255, 255, 0.7); font-size: 0.85em; margin-top: 4px;">
                                            <i class="bi bi-clock"></i> Duration: ${timestamp}
                                        </p>` : ''
                                    }
                                </div>
                            `;
                            
                            // Add click handler for video seek
                            if (startTime) {
                                div.onclick = () => {
                                    console.log('Clicked moment with time:', startTime);
                                    seekToTime(startTime);
                                };
                                div.title = 'Click to jump to ' + startTime;
                            }
                            
                            container.appendChild(div);
                        }, index * 100);
                    });
                }
                
            } else if (result.timecodes && result.timecodes.length > 0) {
                // Original timecode format (for mock analyzer)
                result.timecodes.forEach((item, index) => {
                    setTimeout(() => {
                        const div = document.createElement('div');
                        div.className = 'insight-item timecode';
                        
                        if (item.objects) {
                            // Objects format
                            div.innerHTML = `
                                <span class="timecode-badge">${item.time}</span>
                                <div>
                                    <p style="font-weight: 600; margin-bottom: 8px; color: rgba(255, 255, 255, 0.9);">${item.text}</p>
                                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9em;">
                                        <i class="bi bi-box"></i> ${item.objects.join(', ')}
                                    </p>
                                </div>
                            `;
                        } else if (item.value !== undefined) {
                            // Chart data
                            const barWidth = (item.value / 10) * 100;
                            div.innerHTML = `
                                <span class="timecode-badge">${item.time}</span>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-weight: 600; color: rgba(255, 255, 255, 0.9);">${item.value}</span>
                                        <div style="flex: 1; height: 20px; background: var(--light); border-radius: 10px; overflow: hidden;">
                                            <div style="width: ${barWidth}%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 10px; transition: width 0.5s ease;"></div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            // Regular text with timecode
                            div.innerHTML = `
                                <span class="timecode-badge">${item.time}</span>
                                <div>
                                    <p style="line-height: 1.6; color: rgba(255, 255, 255, 0.85);">${item.text}</p>
                                </div>
                            `;
                        }
                        
                        // Add click handler for video seek
                        if (item.time) {
                            div.onclick = () => seekToTime(item.time);
                        }
                        
                        container.appendChild(div);
                    }, index * 100);
                });
            } else if (result.text) {
                // Display simple text result
                const div = document.createElement('div');
                div.className = 'insight-item';
                div.innerHTML = `
                    <h3 style="color: var(--primary); margin-bottom: 10px;">Analysis Result</h3>
                    <p style="line-height: 1.6; color: rgba(255, 255, 255, 0.85);">${result.text}</p>
                `;
                container.appendChild(div);
            } else {
                // Fallback for unknown format
                const div = document.createElement('div');
                div.className = 'insight-item';
                div.innerHTML = `
                    <h3 style="color: var(--primary); margin-bottom: 10px;">Analysis Result</h3>
                    <p style="line-height: 1.6; color: rgba(255, 255, 255, 0.7);">Analysis completed. Please check the format.</p>
                `;
                container.appendChild(div);
            }
        }
        
        function seekToTime(timeStr) {
            const videoPlayer = document.getElementById('videoPlayer');
            if (!videoPlayer || !timeStr) {
                return;
            }
            
            // Clean the time string and parse it
            const cleanTime = timeStr.trim();
            
            // Parse time string (format: "0:00" or "00:00" or "0:00:00")
            const parts = cleanTime.split(':');
            let seconds = 0;
            
            // Parse each part as integer
            const nums = parts.map(p => parseInt(p, 10));
            
            if (nums.length === 3) {
                // Format: HH:MM:SS
                seconds = nums[0] * 3600 + nums[1] * 60 + nums[2];
            } else if (nums.length === 2) {
                // Format: MM:SS or M:SS
                seconds = nums[0] * 60 + nums[1];
            } else if (nums.length === 1) {
                // Format: SS
                seconds = nums[0];
            }
            
            // Check if the calculated seconds is valid
            if (isNaN(seconds) || seconds < 0) {
                return;
            }
            
            // Set the video time
            videoPlayer.currentTime = seconds;
            
            // Play the video if paused
            if (videoPlayer.paused) {
                videoPlayer.play().catch(e => console.log('Play failed:', e));
            }
        }
        
        function setupVideoTimeline() {
            const video = document.getElementById('videoPlayer');
            const timeline = document.getElementById('videoTimeline');
            const progress = document.getElementById('timelineProgress');
            
            if (!video || !video.duration || !timeline) return;
            
            // Show timeline
            timeline.style.display = 'block';
            document.getElementById('toggleChapters').style.display = 'block';
            
            // Clear existing markers
            const existingMarkers = timeline.querySelectorAll('.timeline-marker');
            existingMarkers.forEach(m => m.remove());
            
            // Add markers for each moment
            videoMarkers.forEach((marker, index) => {
                const seconds = parseTimeToSeconds(marker.time);
                const percentage = (seconds / video.duration) * 100;
                
                if (percentage >= 0 && percentage <= 100) {
                    const markerDiv = document.createElement('div');
                    markerDiv.className = 'timeline-marker';
                    markerDiv.style.left = percentage + '%';
                    markerDiv.dataset.time = marker.time;
                    markerDiv.dataset.index = index;
                    
                    // Add tooltip
                    const tooltip = document.createElement('div');
                    tooltip.className = 'timeline-marker-tooltip';
                    tooltip.textContent = `${marker.time} - ${marker.description.substring(0, 100)}...`;
                    markerDiv.appendChild(tooltip);
                    
                    // Click handler
                    markerDiv.onclick = (e) => {
                        e.stopPropagation();
                        seekToTime(marker.time);
                    };
                    
                    timeline.appendChild(markerDiv);
                }
            });
        }
        
        function updateTimelineProgress() {
            const video = document.getElementById('videoPlayer');
            const progress = document.getElementById('timelineProgress');
            
            if (video && video.duration && progress) {
                const percentage = (video.currentTime / video.duration) * 100;
                progress.style.width = percentage + '%';
            }
        }
        
        function parseTimeToSeconds(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':').map(p => parseInt(p));
            let seconds = 0;
            
            if (parts.length === 3) {
                seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
            } else if (parts.length === 2) {
                seconds = parts[0] * 60 + parts[1];
            } else if (parts.length === 1) {
                seconds = parts[0];
            }
            
            return seconds;
        }
        
        function toggleChapters() {
            const chapters = document.getElementById('videoChapters');
            chapters.classList.toggle('show');
        }
        
        function updateChaptersList() {
            const chaptersList = document.getElementById('chaptersList');
            if (!chaptersList || videoMarkers.length === 0) return;
            
            chaptersList.innerHTML = videoMarkers.map((marker, index) => `
                <div class="chapter-item" data-index="${index}" onclick="jumpToChapter(${index})">
                    <span class="chapter-time">${marker.time}</span>
                    <span>${marker.description.substring(0, 50)}${marker.description.length > 50 ? '...' : ''}</span>
                </div>
            `).join('');
        }
        
        function jumpToChapter(index) {
            if (videoMarkers[index]) {
                seekToTime(videoMarkers[index].time);
                updateActiveChapter();
            }
        }
        
        function formatMessageText(text) {
            // Format timestamps as clickable links
            text = text.replace(/\[(\d{1,2}:\d{2}(?::\d{2})?)\]/g, 
                '<span class="timestamp" onclick="seekToTime(\'$1\')" style="cursor: pointer;">[$1]</span>');
            
            // Format time ranges
            text = text.replace(/\((\d{1,2}:\d{2}(?::\d{2})?)\s*-\s*(\d{1,2}:\d{2}(?::\d{2})?)\)/g, 
                '(<span class="timestamp" onclick="seekToTime(\'$1\')" style="cursor: pointer;">$1</span>-<span class="timestamp" onclick="seekToTime(\'$2\')" style="cursor: pointer;">$2</span>)');
            
            // Format bold text
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Format code/technical terms
            text = text.replace(/`(.*?)`/g, '<code>$1</code>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Split into paragraphs for better readability
            const paragraphs = text.split(/\n\n+/);
            if (paragraphs.length > 1) {
                text = paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
            } else {
                // For single paragraph, preserve line breaks
                text = text.replace(/\n/g, '<br>');
            }
            
            return text;
        }
        
        function updateActiveChapter() {
            const video = document.getElementById('videoPlayer');
            if (!video || !video.duration) return;
            
            const currentTime = video.currentTime;
            let activeIndex = -1;
            
            // Find the current chapter
            for (let i = videoMarkers.length - 1; i >= 0; i--) {
                const markerTime = parseTimeToSeconds(videoMarkers[i].time);
                if (currentTime >= markerTime) {
                    activeIndex = i;
                    break;
                }
            }
            
            // Update UI if chapter changed
            if (activeIndex !== currentChapterIndex) {
                currentChapterIndex = activeIndex;
                
                // Update chapter list
                const chapters = document.querySelectorAll('.chapter-item');
                chapters.forEach((ch, i) => {
                    if (i === activeIndex) {
                        ch.classList.add('active');
                    } else {
                        ch.classList.remove('active');
                    }
                });
            }
        }
        
        function enableChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="message ai">
                    <p>Hello! The video has been loaded. Feel free to ask me any questions about its content.</p>
                </div>
            `;
            
            // Reset chat history
            chatHistory = [{ role: 'assistant', content: 'Hello! The video has been loaded. Feel free to ask me any questions about its content.' }];
            
            document.getElementById('chatInput').style.display = 'flex';
            document.getElementById('chatMessage').disabled = false;
            document.querySelector('#chatInput button').disabled = false;
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatMessage');
            const message = input.value.trim();
            
            if (!message || !currentVideo) return;
            
            const chatMessages = document.getElementById('chatMessages');
            
            // Add user message
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'message user';
            userMsgDiv.innerHTML = formatMessageText(message);
            chatMessages.appendChild(userMsgDiv);
            
            // Add to chat history
            chatHistory.push({ role: 'user', content: message });
            
            // Create AI message container for streaming
            const aiMsgDiv = document.createElement('div');
            aiMsgDiv.className = 'message ai';
            aiMsgDiv.id = 'streamingMessage';
            const aiMsgContent = document.createElement('p');
            aiMsgContent.innerHTML = '<i class="bi bi-three-dots" style="animation: pulse 1s infinite;"></i>';
            aiMsgDiv.appendChild(aiMsgContent);
            chatMessages.appendChild(aiMsgDiv);
            
            input.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Try streaming first, fallback to regular chat
            const useStreaming = true;
            
            if (useStreaming) {
                try {
                    // Get transcription - check if we need to fetch it first
                    let transcription = '';
                    
                    if (currentVideo.hasYoutubeTranscript) {
                        // YouTube transcript is already on server, we can use empty string
                        // The server will use the cached YouTube transcript
                        console.log(' CHAT: Using YouTube transcript from server cache');
                        console.log(' Fast response - no video processing needed');
                        transcription = 'YOUTUBE_CACHED'; // Special marker for server
                    } else if (currentVideo.transcription) {
                        // Use existing transcription
                        console.log(' CHAT: Using previously generated transcription');
                        transcription = typeof currentVideo.transcription === 'object' ? 
                            currentVideo.transcription.transcription || '' : 
                            currentVideo.transcription;
                    } else {
                        // Need to fetch transcription first
                        console.log(' CHAT: No transcription available');
                        console.log(' Fetching transcription from video...');
                        const trans = await fetchTranscription(currentVideo.filename);
                        transcription = trans || '';
                        console.log(' Transcription fetched');
                    }
                    
                    const eventSource = new EventSource('/chat/stream?' + new URLSearchParams({
                        transcription: transcription,
                        question: message,
                        context: JSON.stringify(chatHistory.slice(-5))
                    }));
                    
                    let fullResponse = '';
                    let firstChunk = true;
                    
                    eventSource.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'start') {
                            aiMsgContent.innerHTML = '';
                        } else if (data.type === 'chunk') {
                            if (firstChunk) {
                                aiMsgContent.innerHTML = '';
                                firstChunk = false;
                            }
                            fullResponse += data.content + ' ';
                            aiMsgContent.innerHTML = formatMessageText(fullResponse);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        } else if (data.type === 'end') {
                            eventSource.close();
                            chatHistory.push({ role: 'assistant', content: fullResponse });
                        }
                    };
                    
                    eventSource.onerror = async (error) => {
                        eventSource.close();
                        console.log('Streaming failed, using regular chat');
                        
                        // Fallback to regular chat
                        await sendMessageRegular(message, aiMsgContent);
                    };
                    
                } catch (error) {
                    await sendMessageRegular(message, aiMsgContent);
                }
            } else {
                await sendMessageRegular(message, aiMsgContent);
            }
        }
        
        async function sendMessageRegular(message, aiMsgContent) {
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transcription: currentVideo.transcription || '',
                        question: message,
                        context: chatHistory.slice(-5)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Display response with typing effect
                    aiMsgContent.innerHTML = '';
                    let displayText = '';
                    const words = data.response.split(' ');
                    
                    for (let i = 0; i < words.length; i++) {
                        displayText += words[i] + ' ';
                        aiMsgContent.innerHTML = formatMessageText(displayText);
                        
                        // Small delay for typing effect
                        await new Promise(resolve => setTimeout(resolve, 30));
                        
                        // Scroll to bottom
                        const chatMessages = document.getElementById('chatMessages');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                    
                    // Add to chat history
                    chatHistory.push({ role: 'assistant', content: data.response });
                } else {
                    aiMsgContent.innerHTML = `<i class="bi bi-exclamation-circle"></i> Error: ${data.error}`;
                }
            } catch (error) {
                aiMsgContent.innerHTML = `<i class="bi bi-exclamation-circle"></i> Error: ${error.message}`;
            }
        }
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            navigator.sendBeacon('/cleanup', JSON.stringify({}));
        });
        
        // Helper function to format duration
        function formatDuration(seconds) {
            if (!seconds || seconds === 0) return '0:00';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Loading overlay functions for complete flow
        function showLoading(status, message) {
            const overlay = document.getElementById('loadingOverlay');
            const appContainer = document.querySelector('.app-container');
            const statusEl = document.getElementById('loadingStatus');
            const messageEl = document.getElementById('loadingMessage');
            
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.classList.add('active');
                appContainer.classList.add('slide-out');
            }, 10);
            
            statusEl.textContent = status;
            messageEl.textContent = message;
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            const appContainer = document.querySelector('.app-container');
            
            overlay.classList.remove('active');
            appContainer.classList.remove('slide-out');
            
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500);
            
            if (typeof messageInterval !== 'undefined') {
                clearInterval(messageInterval);
            }
        }
        
        function updateLoadingStep(stepName, state) {
            const step = document.getElementById(`step-${stepName}`);
            if (step) {
                step.classList.remove('active', 'completed');
                if (state) {
                    step.classList.add(state);
                }
            }
        }
        
        const loadingMessages = {
            download: [
                "Connecting to video source...",
                "Downloading video content...",
                "Processing video data...",
                "Almost there..."
            ],
            process: [
                "Extracting video frames...",
                "Preparing for analysis...",
                "Optimizing video quality..."
            ],
            analyze: [
                "AI is analyzing your video...",
                "Extracting key moments...",
                "Generating insights...",
                "Finalizing analysis..."
            ]
        };
        
        let messageIndex = 0;
        let messageInterval;
        
        function startMessageRotation(stage) {
            messageIndex = 0;
            clearInterval(messageInterval);
            
            messageInterval = setInterval(() => {
                const messages = loadingMessages[stage] || [];
                if (messages.length > 0) {
                    document.getElementById('loadingMessage').textContent = 
                        messages[messageIndex % messages.length];
                    messageIndex++;
                }
            }, 2000);
        }
        
        // Complete flow with loading - nothing shows until analysis is done
        async function processVideoComplete() {
            const url = document.getElementById('videoUrl').value.trim();
            if (!url) {
                showAlert('<i class="bi bi-exclamation-triangle"></i> Please enter a video URL', 'error');
                return;
            }
            
            // Show loading overlay
            showLoading('Downloading video...', 'Please wait while we fetch your video');
            updateLoadingStep('download', 'active');
            startMessageRotation('download');
            
            try {
                // Step 1: Download video
                const downloadResponse = await fetch('/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                
                const downloadData = await downloadResponse.json();
                
                if (!downloadData.success) {
                    throw new Error(downloadData.error || 'Download failed');
                }
                
                // Store video data
                currentVideo = downloadData;
                
                // Update loading state
                updateLoadingStep('download', 'completed');
                updateLoadingStep('process', 'active');
                showLoading('Processing video...', 'Preparing your video for analysis');
                startMessageRotation('process');
                
                // Fetch transcription and wait for it
                if (downloadData.filename) {
                    const transcription = await fetchTranscription(downloadData.filename);
                    if (transcription && currentVideo) {
                        currentVideo.transcription = transcription;
                        console.log('Transcription ready for chat');
                    }
                }
                
                // Wait a bit for visual effect
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Step 2: Analyze video
                updateLoadingStep('process', 'completed');
                updateLoadingStep('analyze', 'active');
                showLoading('Analyzing video...', 'AI is processing your video');
                startMessageRotation('analyze');
                
                const analyzeResponse = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: downloadData.filename,
                        mode: 'summary',
                        custom_prompt: null
                    })
                });
                
                const analyzeData = await analyzeResponse.json();
                
                if (!analyzeData.success) {
                    throw new Error(analyzeData.error || 'Analysis failed');
                }
                
                // Step 3: Everything successful - show UI
                updateLoadingStep('analyze', 'completed');
                
                // Wait a moment to show completion
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Hide loading
                hideLoading();
                
                // Now show everything at once
                showCompleteUI(downloadData, analyzeData);
                
            } catch (error) {
                hideLoading();
                showAlert(`<i class="bi bi-x-circle"></i> Error: ${error.message}`, 'error');
            }
        }
        
        function showCompleteUI(videoData, analysisData) {
            // Remove centered class from input
            document.getElementById('inputSection').classList.remove('centered');
            
            // Show main content grid
            const mainContent = document.getElementById('mainContent');
            mainContent.style.display = 'grid';
            mainContent.classList.add('fade-in');
            
            // Setup video player
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.src = `/stream/${videoData.filename}`;
            videoPlayer.style.display = 'block';
            document.getElementById('videoPlaceholder').style.display = 'none';
            
            // Initialize custom video controls
            setTimeout(initializeVideoControls, 100);
            
            // Show video info
            if (videoData.video_info) {
                const info = videoData.video_info;
                document.getElementById('videoTitle').textContent = info.title || 'Untitled Video';
                document.getElementById('videoMeta').innerHTML = `
                    <span><i class="bi bi-person"></i> ${info.uploader || 'Unknown'}</span>
                    <span><i class="bi bi-eye"></i> ${(info.view_count || 0).toLocaleString()} views</span>
                    <span><i class="bi bi-clock"></i> ${formatDuration(info.duration || 0)}</span>
                `;
                document.getElementById('videoInfo').style.display = 'block';
            }
            
            // Show analysis section with slight delay
            setTimeout(() => {
                const analysisSection = document.getElementById('analysisSection');
                if (analysisSection) {
                    analysisSection.style.display = 'block';
                    analysisSection.classList.add('fade-in');
                }
                
                // Show mode selector
                document.getElementById('modeSelector').style.display = 'block';
                document.getElementById('analysisLoading').style.display = 'none';
                
                // Display analysis results
                displayAnalysisResults(analysisData.result);
                
                // Update status
                const status = document.getElementById('analysisStatus');
                status.style.display = 'block';
                status.innerHTML = `
                    <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                        <i class="bi bi-check-circle"></i> Analysis Complete
                    </span>
                `;
                
                // Show chat section
                const chatSection = document.getElementById('chatSection');
                if (chatSection) {
                    chatSection.style.display = 'block';
                    chatSection.classList.add('fade-in');
                    enableChat();
                }
            }, 300);
            
            // Clear URL input
            document.getElementById('videoUrl').value = '';
            
            // Show success message
            showAlert('<i class="bi bi-check-circle"></i> Video analysis complete!', 'success');
        }
        
        // Video Player Custom Controls
        function initializeVideoControls() {
            const video = document.getElementById('videoPlayer');
            const videoContainer = document.querySelector('.video-container');
            const controls = document.getElementById('videoControls');
            const playBtn = document.getElementById('playBtn');
            const playOverlay = document.querySelector('.play-overlay');
            const progressBar = document.getElementById('progressBar');
            const progressFilled = document.getElementById('progressFilled');
            const currentTimeSpan = document.getElementById('currentTime');
            const durationSpan = document.getElementById('duration');
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeBtn = document.getElementById('volumeBtn');
            const speedBtn = document.getElementById('speedBtn');
            const speedOptions = document.getElementById('speedOptions');
            const pipBtn = document.getElementById('pipBtn');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const videoLoading = document.querySelector('.video-loading');
            
            if (!video || !controls) return;
            
            // Show controls when video loads
            video.addEventListener('loadedmetadata', () => {
                controls.style.display = 'flex';
                durationSpan.textContent = formatTime(video.duration);
                
                // Show play overlay
                if (playOverlay && video.paused) {
                    playOverlay.style.display = 'flex';
                }
            });
            
            // Format time helper
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
            
            // Play/Pause functionality
            function togglePlayPause() {
                if (video.paused) {
                    video.play();
                    videoContainer.classList.add('playing');
                    playBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
                    if (playOverlay) playOverlay.style.display = 'none';
                } else {
                    video.pause();
                    videoContainer.classList.remove('playing');
                    playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
                    if (playOverlay) playOverlay.style.display = 'flex';
                }
            }
            
            playBtn.addEventListener('click', togglePlayPause);
            if (playOverlay) {
                playOverlay.addEventListener('click', togglePlayPause);
            }
            
            // Click on video to play/pause
            video.addEventListener('click', togglePlayPause);
            
            // Update progress bar
            video.addEventListener('timeupdate', () => {
                const percent = (video.currentTime / video.duration) * 100;
                progressFilled.style.width = `${percent}%`;
                currentTimeSpan.textContent = formatTime(video.currentTime);
            });
            
            // Seek functionality
            progressBar.addEventListener('click', (e) => {
                const rect = progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                video.currentTime = percent * video.duration;
            });
            
            // Volume control
            volumeSlider.addEventListener('input', (e) => {
                video.volume = e.target.value / 100;
                updateVolumeIcon();
            });
            
            function updateVolumeIcon() {
                const volume = video.volume;
                let icon = 'bi-volume-up-fill';
                if (volume === 0) {
                    icon = 'bi-volume-mute-fill';
                } else if (volume < 0.5) {
                    icon = 'bi-volume-down-fill';
                }
                volumeBtn.innerHTML = `<i class="bi ${icon}"></i>`;
            }
            
            volumeBtn.addEventListener('click', () => {
                if (video.volume > 0) {
                    video.volume = 0;
                    volumeSlider.value = 0;
                } else {
                    video.volume = 1;
                    volumeSlider.value = 100;
                }
                updateVolumeIcon();
            });
            
            // Speed control
            speedBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                speedOptions.classList.toggle('show');
            });
            
            document.querySelectorAll('.speed-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const speed = parseFloat(e.target.dataset.speed);
                    video.playbackRate = speed;
                    speedBtn.textContent = `${speed}x`;
                    
                    document.querySelectorAll('.speed-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    speedOptions.classList.remove('show');
                });
            });
            
            // Close speed options when clicking outside
            document.addEventListener('click', (e) => {
                if (!speedBtn.contains(e.target) && !speedOptions.contains(e.target)) {
                    speedOptions.classList.remove('show');
                }
            });
            
            // Picture-in-Picture
            if (pipBtn && document.pictureInPictureEnabled) {
                pipBtn.addEventListener('click', async () => {
                    try {
                        if (document.pictureInPictureElement) {
                            await document.exitPictureInPicture();
                        } else {
                            await video.requestPictureInPicture();
                        }
                    } catch (error) {
                        console.error('PiP error:', error);
                    }
                });
            } else if (pipBtn) {
                pipBtn.style.display = 'none';
            }
            
            // Fullscreen
            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    videoContainer.requestFullscreen().catch(err => {
                        console.error('Fullscreen error:', err);
                    });
                    fullscreenBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
                } else {
                    document.exitFullscreen();
                    fullscreenBtn.innerHTML = '<i class="bi bi-fullscreen"></i>';
                }
            });
            
            // Update fullscreen button on fullscreen change
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    fullscreenBtn.innerHTML = '<i class="bi bi-fullscreen"></i>';
                }
            });
            
            // Show/hide controls on hover
            let controlsTimeout;
            
            function showControls() {
                controls.style.opacity = '1';
                videoContainer.style.cursor = 'default';
                clearTimeout(controlsTimeout);
                
                if (!video.paused) {
                    controlsTimeout = setTimeout(() => {
                        controls.style.opacity = '0';
                        videoContainer.style.cursor = 'none';
                    }, 3000);
                }
            }
            
            videoContainer.addEventListener('mousemove', showControls);
            videoContainer.addEventListener('mouseenter', showControls);
            videoContainer.addEventListener('mouseleave', () => {
                if (!video.paused) {
                    controls.style.opacity = '0';
                }
            });
            
            // Show loading spinner
            video.addEventListener('waiting', () => {
                if (videoLoading) videoLoading.classList.add('show');
            });
            
            video.addEventListener('canplay', () => {
                if (videoLoading) videoLoading.classList.remove('show');
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (video && videoContainer.contains(document.activeElement)) {
                    switch(e.key) {
                        case ' ':
                        case 'k':
                            e.preventDefault();
                            togglePlayPause();
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            video.currentTime -= 10;
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            video.currentTime += 10;
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            video.volume = Math.min(1, video.volume + 0.1);
                            volumeSlider.value = video.volume * 100;
                            updateVolumeIcon();
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            video.volume = Math.max(0, video.volume - 0.1);
                            volumeSlider.value = video.volume * 100;
                            updateVolumeIcon();
                            break;
                        case 'f':
                            e.preventDefault();
                            fullscreenBtn.click();
                            break;
                        case 'm':
                            e.preventDefault();
                            volumeBtn.click();
                            break;
                    }
                }
            });
        }
        
        // Initialize video controls when video is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.addedNodes.length) {
                        mutation.addedNodes.forEach((node) => {
                            if (node.id === 'videoPlayer' || (node.querySelector && node.querySelector('#videoPlayer'))) {
                                setTimeout(initializeVideoControls, 100);
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>
    
    <!-- Footer -->
    <footer style="
        margin-top: 60px;
        padding: 30px 20px;
        background: var(--surface);
        border-top: 1px solid var(--border);
        text-align: center;
    ">
        <p style="
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.6;
            margin-bottom: 10px;
        ">
            Project developed as an assessment for the <strong style="color: var(--primary);">Full Stack Developer</strong> position challenge at <strong style="color: var(--primary);">SAMO Technologies</strong>
        </p>
        <p style="
            color: var(--text-muted);
            font-size: 0.85em;
        ">
            Developed by <a href="https://github.com/henrique221" target="_blank" style="color: var(--text-secondary); text-decoration: none; font-weight: 600; transition: color 0.3s; display: inline-flex; align-items: center; gap: 5px;" 
                onmouseover="this.style.color='var(--primary)'" 
                onmouseout="this.style.color='var(--text-secondary)'">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/>
                </svg>
                Henrique Borges da Silva
            </a>
        </p>
    </footer>
</body>
</html>